"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[911],{1760:function(e,t,r){r.d(t,{gW:function(){return eW}});var i,a,s,n,o,l,d,h,u,c,g,x,y=r(7294);let m={scale:1,offset:{x:0,y:0}};(i=d||(d={})).TOP="TOP",i.BOTTOM="BOTTOM",i.LEFT="LEFT",i.RIGHT="RIGHT",i.TOPLEFT="TOPLEFT",i.TOPRIGHT="TOPRIGHT",i.BOTTOMLEFT="BOTTOMLEFT",i.BOTTOMRIGHT="BOTTOMRIGHT";let L={columnCount:10,rowCount:10};(a=h||(h={})).PANNING="PANNING",a.PINCHZOOMING="PINCHZOOMING",a.EXTENDING="EXTENDING",a.DRAWING="DRAWING",a.NULL="NULL";let f="current-device-user-id",I="#999999",p="#ffffff";class C extends Error{constructor(e){super(e),this.name="DottingError"}}class P extends C{constructor(e){super(`Duplicate layer id ${e}. Please make sure all layer ids are unique.`),this.name="DuplicateLayerIdError"}}class S extends C{constructor(e){let t=e?` for layer ${e}`:"";super(`Invalid square data${t}. Please make sure all data have the same row and column count.`),this.name="InvalidSquareDataError"}}class w extends C{constructor(e){let t=e?` for layer ${e}`:"";super(`Invalid data dimensions${t}. Please make sure all data have the same dimensions.`),this.name="InvalidDataDimensionsError"}}class A extends C{constructor(e){let t=e?` for layer ${e}`:"";super(`Invalid data indices${t}. Please make sure all data have the same topRowIndex and leftColumnIndex.`),this.name="InvalidDataIndicesError"}}class E extends C{constructor(){super("Layer id has not been specified"),this.name="UnspecifiedLayerIdError"}}class T extends C{constructor(e){super(`Layer ${e} not found.`),this.name="LayerNotFoundError"}}class v extends C{constructor(){super("Unrecognized download option."),this.name="UnrecognizedDownloadOptionError"}}class D extends C{constructor(){super("No data to make svg."),this.name="NoDataToMakeSvgError"}}let b=(e,t,r)=>{let i={x:t.x+e.width/r/2,y:t.y+e.height/r/2};return i};function R(e,t){return{x:e.x-t.x,y:e.y-t.y}}function B(e,t){return{x:e.x+t.x,y:e.y+t.y}}function M(e,t){let{offset:r,scale:i}=t;return{x:Math.floor(e.x*i+r.x),y:Math.floor(e.y*i+r.y)}}function O(e,t){let{offset:r,scale:i}=t;return{x:(e.x-r.x)/i,y:(e.y-r.y)/i}}let k=(e,t,r)=>{let i,a,s,n;if(window.TouchEvent&&e instanceof TouchEvent){let i=!1,a=0;for(let t=0;t<e.touches.length;t++){let r=e.touches.item(t).target;if(r instanceof HTMLCanvasElement){i=!0,a=t;break}}return i?G(e.touches[a],t,r):G(e.touches[0],t,r)}return i=e.clientY,a=e.clientX,s=e.offsetX,n=e.offsetY,i+=window.scrollY,a+=window.scrollX,{y:i-r.offset.y,x:a-r.offset.x,offsetX:s,offsetY:n}},G=(e,t,r)=>{let i=t.getBoundingClientRect(),a=e.clientY,s=e.clientX,n=e.clientX-i.left,o=e.clientY-i.top;return{x:s-r.offset.x,y:a-r.offset.y,offsetX:n,offsetY:o}},W=(e,t,r,i,a,s,n)=>{if(e.preventDefault(),!(window.TouchEvent&&e instanceof TouchEvent))return null;{let o=e.touches.length;if(o<2)return;let l=[];for(let t=0;t<o;t++){let r=e.touches.item(t).target;r instanceof HTMLCanvasElement&&l.push(t)}if(2!==l.length)return;let d=e.touches[l[0]],h=e.touches[l[1]],u=Math.abs(d.clientX-h.clientX)+Math.abs(d.clientY-h.clientY),c=G(d,t,r),g=G(h,t,r),x={x:(c.offsetX+g.offsetX)/2,y:(c.offsetY+g.offsetY)/2};if(!a)return{pinchZoomDiff:u,panZoom:r};let y=r.scale*(1-2*(a-u)/(2*i));if(s>y||y>n)return;let m=O(x,{scale:r.scale,offset:r.offset}),L=M(m,{scale:y,offset:r.offset}),f=R(x,L),I=B(r.offset,f);return{pinchZoomDiff:u,panZoom:{scale:y,offset:I}}}},H=(e,t,r,i)=>{e.preventDefault();let a=k(e,t,r),s={x:a.offsetX,y:a.offsetY},n=O(s,r),o=R(n,{x:t.width/i/2,y:t.height/i/2});return o},F=(e,t,r,i)=>{if(e.preventDefault(),e.touches&&e.touches.length<2||e.touches.length>2)return null;let a=e.touches[0],s=e.touches[1],n=G(a,t,r),o=G(s,t,r),l={x:(n.offsetX+o.offsetX)/2,y:(n.offsetY+o.offsetY)/2},d=O(l,r),h=R(d,{x:t.width/i/2,y:t.height/i/2});return h},Z=(e,t,r,i)=>{let a=r[0],s=t[0],n={x:a*i,y:s*i};if(e.x>n.x&&e.x<n.x+r.length*i&&e.y>n.y&&e.y<n.y+t.length*i){let a=Math.floor((e.y-n.y)/i),s=Math.floor((e.x-n.x)/i);return{rowIndex:t[a],columnIndex:r[s]}}return null},q=(e,t)=>{let{areaTopLeftPos:r,areaBottomRightPos:i}=K(t);return e.x>=r.x&&e.x<=i.x&&e.y>=r.y&&e.y<=i.y},N=(e,t,r,i)=>{if(!e)return!1;let{areaTopLeftPos:a,areaBottomRightPos:s}=K(e),n={x:-(r/2*i),y:-(t/2*i)},o={x:r/2*i,y:t/2*i};return a.x<=o.x||a.y<=o.y||s.x>=n.x||s.y>=n.y},K=e=>{let t=e.startWorldPos.x<e.endWorldPos.x,r=e.startWorldPos.y<e.endWorldPos.y,i={x:t?e.startWorldPos.x:e.endWorldPos.x,y:r?e.startWorldPos.y:e.endWorldPos.y},a={x:t?e.endWorldPos.x:e.startWorldPos.x,y:r?e.endWorldPos.y:e.startWorldPos.y};return{areaTopLeftPos:i,areaBottomRightPos:a}},_=(e,t,r,i,a,s)=>{let{areaTopLeftPos:n,areaBottomRightPos:o}=K(e),l={x:0,y:0},d={x:0,y:0},h={x:0,y:0},u=n.x-l.x;if(u<0)d.x=l.x;else{if(u>r*i)return null;d.x=l.x+Math.floor(u/i)*i}let c=n.y-l.y;if(c<0)d.y=l.y;else{if(c>t*i)return null;d.y=l.y+Math.floor(c/i)*i}let g=o.x-(l.x+r*i);if(g>0)h.x=l.x+r*i;else{if(g<-r*i)return null;h.x=l.x+r*i+Math.ceil(g/i)*i}let x=o.y-(l.y+t*i);if(x>0)h.y=l.y+t*i;else{if(x<-t*i)return null;h.y=l.y+t*i+Math.ceil(x/i)*i}let y=Math.floor((d.y-l.y)/i),m=Math.floor((d.x-l.x)/i),L=Math.floor((h.y-l.y)/i),f=Math.floor((h.x-l.x)/i),I=[];for(let e=y;e<L;e++)for(let t=m;t<f;t++)I.push({rowIndex:a[e],columnIndex:s[t]});return{startWorldPos:d,endWorldPos:h,includedPixelsIndices:I}},z=(e,t,r)=>{let i=O(e,t),a=M(i,{scale:r,offset:t.offset}),s=R(e,a),n=B(t.offset,s);return n},j=(e,t,r,i,a)=>{if(i<0||r<0)throw Error("modifyPixelHeightRatio and modifyPixelWidthRatio should be positive");if(a<0)throw Error("gridSquareLength should be positive");let s=[];for(let n of e){let e={rowOffset:n.rowIndex-t.rowIndex,columnOffset:n.columnIndex-t.columnIndex},o={x:e.columnOffset*a,y:e.rowOffset*a},l={topLeft:{x:o.x*r,y:o.y*i},topRight:{x:(o.x+a)*r,y:o.y*i},bottomLeft:{x:o.x*r,y:(o.y+a)*i},bottomRight:{x:(o.x+a)*r,y:(o.y+a)*i}};for(let e=l.topLeft.x;e<l.topRight.x;e+=a)for(let r=l.topLeft.y;r<l.bottomLeft.y;r+=a){let i={rowIndex:Math.round(t.rowIndex+Math.floor(r/a)),columnIndex:Math.round(t.columnIndex+Math.floor(e/a)),color:n.color,previousColor:n.previousColor};s.push(i)}}return s},X=e=>{let t=Array.from(e.keys()),r=Array.from(e.get(t[0]).keys());return{topRowIndex:Math.min(...t),bottomRowIndex:Math.max(...t),leftColumnIndex:Math.min(...r),rightColumnIndex:Math.max(...r)}},V=e=>{let t=Array.from(e.keys()),r=Array.from(e.get(t[0]).keys());return{rowIndices:t.sort((e,t)=>e-t),columnIndices:r.sort((e,t)=>e-t)}},Y=e=>Array.from(e.keys()).sort((e,t)=>e-t),U=e=>{let t=Y(e),r=Array.from(e.get(t[0]).keys()).sort((e,t)=>e-t);return r},$=e=>0===e.size?0:e.entries().next().value[1].size,J=e=>e.size,Q=(e,t)=>{let r=e.get(t),i=[];return Array.from(r.entries()).forEach(e=>{let[r,a]=e;a.color&&i.push({color:a.color,rowIndex:t,columnIndex:r})}),i},ee=(e,t)=>{let r=[];return Array.from(e.entries()).map(e=>{let i=e[0],a=e[1];a.get(t).color&&r.push({rowIndex:i,columnIndex:t,color:a.get(t).color})}),r},et=(e,t)=>{e.has(t)&&e.delete(t)},er=(e,t)=>{e.forEach(e=>{e.has(t)&&e.delete(t)})},ei=(e,t,r)=>{let i=U(e);if(!e.has(t))for(let r of(e.set(t,new Map),i))e.get(t).set(r,{color:""})},ea=(e,t,r)=>{e.forEach(e=>{e.has(t)||e.set(t,{color:""})})},es=e=>{let t=e.length,r=0,i=!0;if(t<2)i=!1;else{let a=e[0].length;if(r=a,a<2)i=!1;else for(let r=0;r<t;r++)if(e[r].length!==a){i=!1;break}}return{isDataValid:i,columnCount:r,rowCount:t}},en=e=>{let t=Y(e),r=t.sort((e,t)=>e-t),i=new Map;return r.forEach((e,t)=>{i.set(e,t)}),i},eo=e=>{let t=U(e),r=t.sort((e,t)=>e-t),i=new Map;return r.forEach((e,t)=>{i.set(e,t)}),i},el=(e,t,r,i)=>{if(!e||!t)return[];if(Math.abs(t.x-e.x)>=r||Math.abs(t.y-e.y)>=r){X(i);let{rowIndices:a,columnIndices:s}=V(i),n=Z(t,a,s,r),o=Z(e,a,s,r);if(!o||!n)return;if(Math.abs(n.columnIndex-o.columnIndex)>=1||Math.abs(n.rowIndex-o.rowIndex)>=1){let e=function(e,t,r,i){let a={x1:e,y1:t},s={x2:r,y2:i},n=r-e,o=i-t,l=Math.abs(n)>=Math.abs(o),d=n>=0?1:-1,h=o>=0?1:-1,u=d*n,c=h*o,g=l?2*c-u:2*u-c,x=l?2*c:2*u,y=l?2*(c-u):2*(u-c),m=a.x1,L=a.y1,f=[];if(l)for(;m!=s.x2;)f.push({rowIndex:m,columnIndex:L}),g<0?g+=x:(g+=y,L+=h),m+=d;else for(;L!=s.y2;)f.push({rowIndex:m,columnIndex:L}),g<0?g+=x:(g+=y,m+=d),L+=h;return f}(o.rowIndex,o.columnIndex,n.rowIndex,n.columnIndex);if(e.length>0)return e}}},ed=e=>{if(!e)throw Error("No layer provided");if(0===e.length)throw Error("initLayers should not be empty. Please provide at least one layer.");let t=new Set,r=null,i=null,a=null,s=null;return e.forEach(e=>{if(t.has(e.id))throw new P(e.id);t.add(e.id);let{isDataValid:n,columnCount:o,rowCount:l}=es(e.data);if(null!==r&&null!==i){if(r!==o||i!==l)throw new w(e.id)}else r=o,i=l;if(!n)throw new S(e.id);(null==s||null==a)&&(s=e.data[0][0].columnIndex,a=e.data[0][0].rowIndex);let d=e.data[0][0].rowIndex,h=e.data[0][0].columnIndex;if(d!==a||h!==s)throw new A(e.id)}),!0};class eh{constructor({canvas:e}){this.panZoom=m,this.rowKeyOrderMap=new Map,this.columnKeyOrderMap=new Map,this.topRowIndex=0,this.leftColumnIndex=0,this.ctx=e.getContext("2d"),this.element=e}getContext(){return this.ctx}getElement(){return this.element}getRowKeyOrderMap(){return this.rowKeyOrderMap}getColumnKeyOrderMap(){return this.columnKeyOrderMap}setPanZoom(e){this.panZoom=e}setCriterionDataForRendering(e){this.criterionDataForRendering=e,this.rowKeyOrderMap=en(e),this.columnKeyOrderMap=eo(e)}scale(e,t){this.ctx.scale(e,t)}setWidth(e,t){this.width=e,this.element.width=t?e*t:e,this.element.style.width=`${e}px`}setHeight(e,t){this.height=e,this.element.height=t?e*t:e,this.element.style.height=`${e}px`}setDpr(e){this.dpr=e}getWidth(){return this.width}getHeight(){return this.height}setSize(e,t,r){this.setWidth(e,r),this.setHeight(t,r),this.dpr=r||this.dpr}setTopRowIndex(e){this.topRowIndex=e}setLeftColumnIndex(e){this.leftColumnIndex=e}getTopRowIndex(){return this.topRowIndex}getLeftColumnIndex(){return this.leftColumnIndex}}class eu{constructor(){this.observers=[]}subscribe(e){this.observers.push(e)}unsubscribe(e){this.observers=this.observers.filter(t=>t!==e)}notify(e){this.observers.forEach(t=>t.update(e))}}class ec extends eu{constructor({data:e,id:t}){super(),this.isVisible=!0,this.getColumnKeysFromData=()=>{let e=Array.from(this.data.keys()),t=Array.from(this.data.get(e[0]).keys());return t},this.addRowToData=e=>{let t=this.columnKeys;if(this.data.has(e))return null;for(let r of(this.data.set(e,new Map),this.rowKeys.add(e),t))this.data.get(e).set(r,{color:""});return this.notify(this.getData()),e},this.addColumnToData=e=>{let t=null;return this.data.forEach(r=>{r.has(e)||(t=e,r.set(e,{color:""}))}),this.notify(this.getData()),this.columnKeys.add(e),t},this.getCopiedData=()=>{let e=new Map;return this.data.forEach((t,r)=>{e.set(r,new Map),t.forEach((t,i)=>{e.get(r).set(i,Object.assign({},t))})}),e};let{isDataValid:r}=es(e),i=e[0][0].columnIndex,a=e[0][0].rowIndex;if(!r)throw Error("Data is not valid");this.data=new Map,this.id=t;for(let t=0;t<e.length;t++){this.data.set(a+t,new Map);for(let r=0;r<e[t].length;r++)this.data.get(a+t).set(i+r,{color:e[t][r].color})}this.rowKeys=new Set(this.data.keys()),this.columnKeys=new Set(this.data.get(a).keys())}getDataInfo(){let e=X(this.data),t=$(this.data),r=J(this.data);return{gridIndices:e,columnCount:t,rowCount:r}}getId(){return this.id}deleteRowOfData(e){let t=null;if(!this.data.has(e))throw Error("Row does not exist");return t=e,this.data.delete(e),this.rowKeys.delete(e),this.notify(this.getData()),t}deleteColumnOfData(e){let t=null;return this.data.forEach(r=>{if(!r.has(e))throw Error("Column does not exist");t=e,r.delete(e)}),this.columnKeys.delete(e),this.notify(this.getData()),t}clearData(){let e=[],t=[],r=Array.from(this.data.keys()),i=Array.from(this.data.get(r[0]).keys());for(let a of r)for(let r of i)e.push({rowIndex:a,columnIndex:r,color:this.data.get(a).get(r).color}),t.push({rowIndex:a,columnIndex:r,color:""}),this.data.get(a).set(r,{color:""});return this.notify(this.getData()),{previousPixels:e,newPixels:t}}setData(e){this.data=e,this.rowKeys=new Set(e.keys()),this.columnKeys=new Set(e.get(Array.from(e.keys())[0]).keys()),this.notify(this.getData())}setIsVisible(e){this.isVisible=e}getData(){return this.data}getIsVisible(){return this.isVisible}getDataArray(){let e=[];return[...this.data.entries()].forEach(([t,r])=>{let i=[];[...r.entries()].forEach(([e,r])=>{i.push({rowIndex:t,columnIndex:e,color:r.color})}),e.push(i)}),e}}class eg extends eh{constructor({canvas:e,layers:t}){if(super({canvas:e}),this.gridSquareLength=20,this.defaultPixelColor=p,this.capturedImageBitmap=null,this.capturedImageBitmapScale=1,this.offscreenCanvas=null,t){let e=t[0].data[0][0].rowIndex,r=t[0].data[0][0].columnIndex;this.setTopRowIndex(e),this.setLeftColumnIndex(r),this.layers=t.map(e=>new ec({data:e.data,id:e.id}))}else{this.setTopRowIndex(0),this.setLeftColumnIndex(0);let e=[],{rowCount:t,columnCount:r}=L;this.offscreenCanvas=new OffscreenCanvas(r*this.gridSquareLength,t*this.gridSquareLength);for(let i=0;i<t;i++){e.push([]);for(let t=0;t<r;t++)e[i].push({color:"",rowIndex:i,columnIndex:t})}this.layers=[new ec({data:e,id:"layer1"})]}this.currentLayer=this.layers[0]}getColumnCount(){return $(this.getData())}getRowCount(){return J(this.getData())}getGridIndices(){return X(this.getData())}getDimensions(){return{columnCount:this.getColumnCount(),rowCount:this.getRowCount()}}getData(){return this.currentLayer.getData()}getLayer(e){let t=this.layers.find(t=>t.getId()===e);return t||null}getLayerIndex(e){return this.layers.findIndex(t=>t.getId()===e)}getLayers(){return this.layers}createLayer(e,t){let r=this.getLayer(e);if(r)throw Error("Layer already exists");{let r=this.currentLayer.getDataInfo();if(t){let{isDataValid:i,rowCount:a,columnCount:s}=es(t),n=t[0][0].columnIndex,o=t[0][0].rowIndex;if(!i)throw Error("Data is not square");if(n!==r.gridIndices.leftColumnIndex||o!==r.gridIndices.topRowIndex)throw Error("Data grid indice differs from current layer");if(a!==r.rowCount||s!==r.columnCount)throw Error("Data dimensions differs from current layer");return new ec({data:t,id:e})}{let t=[];for(let e=0;e<r.rowCount;e++){t.push([]);for(let i=0;i<r.columnCount;i++)t[e].push({rowIndex:r.gridIndices.topRowIndex+e,columnIndex:r.gridIndices.leftColumnIndex+i,color:""})}return new ec({data:t,id:e})}}}getCopiedData(){let e=new Map;return Array.from(this.getData().entries()).forEach(([t,r])=>{let i=new Map;Array.from(r.entries()).forEach(([e,t])=>{i.set(e,Object.assign({},t))}),e.set(t,i)}),e}getCurrentLayer(){return this.currentLayer}hideLayer(e){let t=this.getLayer(e);if(!t)throw Error("Layer not found");t.setIsVisible(!1)}showLayer(e){let t=this.getLayer(e);if(!t)throw Error("Layer not found");t.setIsVisible(!0)}isolateLayer(e){let t=this.getLayer(e);if(!t)throw Error("Layer not found");this.layers.forEach(e=>e.setIsVisible(!1)),t.setIsVisible(!0)}showAllLayers(){this.layers.forEach(e=>e.setIsVisible(!0))}reorderLayersByIds(e){let t=[];e.forEach(e=>{let r=this.getLayer(e);if(!r)throw Error("Layer not found");t.push(r)}),this.layers=t}setCurrentLayer(e){let t=this.layers.find(t=>t.getId()===e);if(t)this.currentLayer=t;else throw Error("Layer not found")}setData(e,t){if(void 0===t){if(this.layers.length>1)throw Error("Must specify layerId when there are multiple layers");this.currentLayer.setData(e)}else{let r=this.layers.find(e=>e.getId()===t);if(r)r.setData(e);else throw Error("Layer not found")}}setLayers(e){this.layers=[];let t=e[0].data[0][0].rowIndex,r=e[0].data[0][0].columnIndex;this.setTopRowIndex(t),this.setLeftColumnIndex(r),this.layers=e.map(e=>new ec({data:e.data,id:e.id}))}setGridSquareLength(e){this.gridSquareLength=e}setDefaultPixelColor(e){this.defaultPixelColor=e}getCapturedImageBitmap(){return this.capturedImageBitmap}updatePixelColors(e,t){if(!t&&this.layers.length>1)throw Error("Must specify layerId when there are multiple layers");let r=t?this.getLayer(t):this.currentLayer,i=[];if(!r)throw Error("Layer not found");for(let t of e){let{rowIndex:e,columnIndex:a,color:s}=t;r.getData().get(e)&&r.getData().get(e).get(a)&&(i.push({rowIndex:e,columnIndex:a,color:s,previousColor:r.getData().get(e).get(a).color}),r.getData().get(e).set(a,{color:s}))}return i}colorPixels(e,t){if(!t&&this.layers.length>1)throw Error("Must specify layerId when there are multiple layers");let r=t?this.getLayer(t):this.currentLayer;if(!r)throw Error("Layer not found");let i=e.map(e=>e.rowIndex),a=e.map(e=>e.columnIndex),s=Math.min(...i),n=Math.max(...i),o=Math.min(...a),l=Math.max(...a),d=this.getGridIndices(),h=[],u=[];if(s<d.topRowIndex){let e=d.topRowIndex-s,t=Array.from(Array(e),(e,t)=>d.topRowIndex-t-1);h.push(...t)}if(n>d.bottomRowIndex){let e=n-d.bottomRowIndex,t=Array.from(Array(e),(e,t)=>d.bottomRowIndex+t+1);h.push(...t)}if(o<d.leftColumnIndex){let e=d.leftColumnIndex-o,t=Array.from(Array(e),(e,t)=>d.leftColumnIndex-t-1);u.push(...t)}if(l>d.rightColumnIndex){let e=l-d.rightColumnIndex,t=Array.from(Array(e),(e,t)=>d.rightColumnIndex+t+1);u.push(...t)}(h.length>0||u.length>0)&&this.addGridIndices({rowIndicesToAdd:h,columnIndicesToAdd:u});let c=[];for(let t of e){let e=r.getData().get(t.rowIndex).get(t.columnIndex).color,i=t.color;r.getData().get(t.rowIndex).set(t.columnIndex,{color:t.color}),c.push(Object.assign(Object.assign({},t),{color:i,previousColor:e}))}return{dataForAction:c,totalAddedColumnIndices:u,totalAddedRowIndices:h}}erasePixels(e,t){if(!t&&this.layers.length>1)throw Error("Must specify layerId when there are multiple layers");let r=t?this.getLayer(t):this.getCurrentLayer();if(!r)throw Error("Cannot find layer");let i=[];for(let t of e){let e=r.getData().get(t.rowIndex).get(t.columnIndex).color;r.getData().get(t.rowIndex).set(t.columnIndex,{color:""}),i.push(Object.assign(Object.assign({},t),{color:"",previousColor:e}))}return{dataForAction:i}}addRow(e){let t=null;return this.layers.forEach(r=>{t=r.addRowToData(e)}),{validRowIndex:t}}addColumn(e){let t=null;return this.layers.forEach(r=>{t=r.addColumnToData(e)}),{validColumnIndex:t}}deleteRow(e){let t=null;if(!this.getData().has(e))return{swipedPixels:[],validRowIndex:t};let r=Q(this.getData(),e);return this.layers.forEach(r=>{t=r.deleteRowOfData(e)}),{swipedPixels:r,validRowIndex:t}}deleteColumn(e){let t=null,r=this.getData().keys().next().value;if(!this.getData().get(r).has(e))return{swipedPixels:[],validColumnIndex:t};let i=ee(this.getData(),e);return this.layers.forEach(r=>{t=r.deleteColumnOfData(e)}),{swipedPixels:i,validColumnIndex:t}}addGridIndices({rowIndicesToAdd:e,columnIndicesToAdd:t}){let r=[],i=[];for(let t of e){let{validRowIndex:e}=this.addRow(t);null!==e&&r.push(e)}for(let e of t){let{validColumnIndex:t}=this.addColumn(e);null!==t&&i.push(t)}return{validRowIndices:r,validColumnIndices:i}}clear(){let e=[];return this.layers.forEach(t=>{let{newPixels:r}=t.clearData();e.push({layerId:t.getId(),data:r})}),e}deleteGridIndices({rowIndicesToDelete:e,columnIndicesToDelete:t}){let r=[],i=[],a=[];for(let t of e){let{swipedPixels:e,validRowIndex:i}=this.deleteRow(t);a.push(...e),null!==i&&r.push(i)}for(let e of t){let{swipedPixels:t,validColumnIndex:r}=this.deleteColumn(e);a.push(...t),null!==r&&i.push(r)}return{swipedPixels:a,validColumnIndices:i,validRowIndices:r}}updateCapturedImageBitmap(){let e={offset:Object.assign({},this.panZoom.offset),scale:this.panZoom.scale},t=this.gridSquareLength*this.panZoom.scale,r=Y(this.getData()),i=U(this.getData()),a=i.length*t,s=r.length*t;a>2500&&(t=2500/i.length,e.scale=t/this.gridSquareLength),s>2500&&(t=2500/r.length,e.scale=t/this.gridSquareLength);let n=this.dpr?i.length*t*this.dpr:i.length*t,o=this.dpr?r.length*t*this.dpr:r.length*t,l=new OffscreenCanvas(n,o),d=l.getContext("2d");if(!d)throw Error("Cannot get context");for(let e of(this.defaultPixelColor&&(d.save(),d.fillStyle=this.defaultPixelColor,d.fillRect(0,0,t*i.length*this.dpr,t*r.length*this.dpr),d.restore()),d.save(),r))for(let r of i){let i=e,a=r,s=this.rowKeyOrderMap.get(i),n=this.columnKeyOrderMap.get(a);if(void 0===s||void 0===n)continue;let o=this.layers.slice().reverse().reduce((e,t)=>{var r,s;if(!1===t.getIsVisible())return e;let n=null===(s=null===(r=t.getData().get(i))||void 0===r?void 0:r.get(a))||void 0===s?void 0:s.color;return n||e},"");o&&(d.fillStyle=o,d.fillRect(n*t*this.dpr,s*t*this.dpr,t*this.dpr,t*this.dpr))}d.restore(),this.capturedImageBitmapScale=e.scale,this.capturedImageBitmap=l.transferToImageBitmap()}render(){let e=this.ctx,t=this.gridSquareLength*this.panZoom.scale,r=Y(this.getData()),i=U(this.getData()),a={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength};e.clearRect(0,0,this.width,this.height);let s=b(this.element,a,this.dpr),n=M(s,this.panZoom);for(let a of(this.defaultPixelColor&&(e.save(),e.fillStyle=this.defaultPixelColor,e.fillRect(n.x,n.y,t*i.length,t*r.length),e.restore()),e.save(),r))for(let r of i){let i=a,s=r,o=this.rowKeyOrderMap.get(i),l=this.columnKeyOrderMap.get(s);if(void 0===o||void 0===l)continue;let d=this.layers.slice().reverse().reduce((e,t)=>{var r,a;if(!1===t.getIsVisible())return e;let n=null===(a=null===(r=t.getData().get(i))||void 0===r?void 0:r.get(s))||void 0===a?void 0:a.color;return n||e},"");d&&(e.fillStyle=d,e.fillRect(l*t+n.x,o*t+n.y,t,t))}return e.restore(),{rowKeys:r,columnKeys:i}}renderImageBitmap(){if(!this.capturedImageBitmap)throw Error("Captured image data is null");let e={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength},t=b(this.element,e,this.dpr),r=M(t,this.panZoom),i=this.panZoom.scale/this.capturedImageBitmapScale,a=this.capturedImageBitmap.width/this.dpr*i,s=this.capturedImageBitmap.height/this.dpr*i;this.ctx.save(),this.ctx.clearRect(0,0,this.width,this.height),this.ctx.drawImage(this.capturedImageBitmap,r.x,r.y,a,s),this.ctx.restore()}}let ex=(e,t,r,i,a,s)=>{e.save(),e.beginPath(),e.translate(t,r),e.rotate(i),e.moveTo(0,0),e.lineTo(s/2*a,5*a),e.lineTo(-s/2*a,5*a),e.closePath(),e.fillStyle="#000000",e.fill(),e.restore(),e.save(),e.beginPath(),e.translate(t,r),e.rotate(i),e.moveTo(0,0),e.lineTo(0,8*a),e.stroke(),e.closePath(),e.fillStyle="#000000",e.fill(),e.restore()},ey=(e,t,r,i,a,s)=>{e.save(),e.fillStyle=r,e.fillRect(t.x,t.y,i*s,a*s),e.restore()},em=(e,t,r,i,a,s)=>{e.save(),e.beginPath(),e.arc(t.x,t.y,r,0,2*Math.PI),e.fillStyle=i,e.fill(),e.lineWidth=s,e.strokeStyle=a,e.stroke(),e.restore()},eL=(e,t,r,i,a,s,n,o)=>{e.save(),e.beginPath(),e.rect(t,r,i,a),e.fillStyle=s,e.lineWidth=o,e.fill(),e.strokeStyle=n,e.stroke(),e.restore()};class ef extends eh{constructor({columnCount:e,rowCount:t,canvas:r}){super({canvas:r}),this.isGridVisible=!0,this.isGridFixed=!1,this.gridSquareLength=20,this.buttonHeight=30,this.buttonMargin=15,this.extendArrowPadding=2,this.hoveredButton=null,this.topButtonDimensions={x:0,y:0,width:0,height:0},this.bottomButtonDimensions={x:0,y:0,width:0,height:0},this.leftButtonDimensions={x:0,y:0,width:0,height:0},this.rightButtonDimensions={x:0,y:0,width:0,height:0},this.topLeftButtonDimensions={x:0,y:0,width:0,height:0},this.topRightButtonDimensions={x:0,y:0,width:0,height:0},this.bottomLeftButtonDimensions={x:0,y:0,width:0,height:0},this.bottomRightButtonDimensions={x:0,y:0,width:0,height:0},this.columnCount=e,this.rowCount=t,this.ctx=r.getContext("2d"),this.element=r}setColumnCount(e){this.columnCount=e}setRowCount(e){this.rowCount=e}setIsGridVisible(e){void 0!==e&&(this.isGridVisible=e)}getIsGridVisible(){return this.isGridVisible}setIsGridFixed(e){void 0!==e&&(this.isGridFixed=e)}getIsGridFixed(){return this.isGridFixed}getHoveredButton(){return this.hoveredButton}setGridStrokeColor(e){(""!==e||void 0!==e)&&(this.gridStrokeColor=e)}setGridSquareLength(e){this.gridSquareLength=e}getGridStrokeColor(){return this.gridStrokeColor}setGridStrokeWidth(e){(0!==e||void 0!==e)&&(this.gridStrokeWidth=e)}getGridStrokeWidth(){return this.gridStrokeWidth}setHoveredButton(e){this.hoveredButton=e}getButtonsDimensions(){return{top:this.topButtonDimensions,bottom:this.bottomButtonDimensions,left:this.leftButtonDimensions,right:this.rightButtonDimensions,topLeft:this.topLeftButtonDimensions,topRight:this.topRightButtonDimensions,bottomLeft:this.bottomLeftButtonDimensions,bottomRight:this.bottomRightButtonDimensions}}findLeftTopPosForButton(e,t,r,i){let a=this.gridSquareLength*this.columnCount,s=this.gridSquareLength*this.rowCount,n={x:i.x,y:i.y};if(e===d.LEFT)n.x+=-this.buttonMargin-t/2;else if(e===d.RIGHT)n.x+=a+this.buttonMargin-t/2;else if(e===d.TOP)n.y+=-this.buttonMargin-r/2;else if(e===d.BOTTOM)n.y+=s+this.buttonMargin-r/2;else if(e===d.TOPLEFT)n.x+=-this.buttonMargin-t/2,n.y+=-this.buttonMargin-r/2;else if(e===d.TOPRIGHT)n.x+=a+this.buttonMargin-t/2,n.y+=-this.buttonMargin-r/2;else if(e===d.BOTTOMLEFT)n.x+=-this.buttonMargin-t/2,n.y+=s+this.buttonMargin-r/2;else if(e===d.BOTTOMRIGHT)n.x+=a+this.buttonMargin-t/2,n.y+=s+this.buttonMargin-r/2;else throw Error("Invalid button direction");let o=b(this.element,n,this.dpr),l=M(o,this.panZoom);return{worldPos:n,screenPos:l}}drawRightButton(e,t){let r=this.buttonHeight,i=this.rowCount*this.gridSquareLength,{screenPos:a,worldPos:s}=this.findLeftTopPosForButton(d.RIGHT,r,i,t);this.rightButtonDimensions={x:s.x,y:s.y,width:r,height:i},ey(this.ctx,a,e,r,i,this.panZoom.scale),ex(this.ctx,a.x+this.extendArrowPadding*this.panZoom.scale,a.y+i*this.panZoom.scale/2,-Math.PI/2,this.panZoom.scale,5),ex(this.ctx,a.x+(r-this.extendArrowPadding)*this.panZoom.scale,a.y+i*this.panZoom.scale/2,Math.PI/2,this.panZoom.scale,5)}drawLeftButton(e,t){let r=this.buttonHeight,i=this.rowCount*this.gridSquareLength,{screenPos:a,worldPos:s}=this.findLeftTopPosForButton(d.LEFT,r,i,t);this.leftButtonDimensions={x:s.x,y:s.y,width:r,height:i},ey(this.ctx,a,e,r,i,this.panZoom.scale),ex(this.ctx,a.x+this.extendArrowPadding*this.panZoom.scale,a.y+i*this.panZoom.scale/2,-Math.PI/2,this.panZoom.scale,5),ex(this.ctx,a.x+(r-this.extendArrowPadding)*this.panZoom.scale,a.y+i*this.panZoom.scale/2,Math.PI/2,this.panZoom.scale,5)}drawTopButton(e,t){let r=this.columnCount*this.gridSquareLength,i=this.buttonHeight,{screenPos:a,worldPos:s}=this.findLeftTopPosForButton(d.TOP,r,i,t);this.topButtonDimensions={x:s.x,y:s.y,width:r,height:i},ey(this.ctx,a,e,r,i,this.panZoom.scale),ex(this.ctx,a.x+r*this.panZoom.scale/2,a.y+this.extendArrowPadding*this.panZoom.scale,2*Math.PI,this.panZoom.scale,5),ex(this.ctx,a.x+r*this.panZoom.scale/2,a.y+(i-this.extendArrowPadding)*this.panZoom.scale,Math.PI,this.panZoom.scale,5)}drawBottomButton(e,t){let r=this.columnCount*this.gridSquareLength,i=this.buttonHeight,{screenPos:a,worldPos:s}=this.findLeftTopPosForButton(d.BOTTOM,r,i,t);this.bottomButtonDimensions={x:s.x,y:s.y,width:r,height:i},ey(this.ctx,a,e,r,i,this.panZoom.scale),ex(this.ctx,a.x+r*this.panZoom.scale/2,a.y+this.extendArrowPadding*this.panZoom.scale,2*Math.PI,this.panZoom.scale,5),ex(this.ctx,a.x+r*this.panZoom.scale/2,a.y+(i-this.extendArrowPadding)*this.panZoom.scale,Math.PI,this.panZoom.scale,5)}drawDiagonalButtons(e,t,r){let i=this.buttonHeight,a=this.buttonHeight,{screenPos:s,worldPos:n}=this.findLeftTopPosForButton(t,a,i,r);switch(ey(this.ctx,s,e,a,i,this.panZoom.scale),ex(this.ctx,t===d.TOPLEFT||t===d.BOTTOMRIGHT?s.x+this.extendArrowPadding*Math.sqrt(2)*this.panZoom.scale:s.x+(a-this.extendArrowPadding*Math.sqrt(2))*this.panZoom.scale,s.y+this.extendArrowPadding*Math.sqrt(2)*this.panZoom.scale,t===d.TOPLEFT||t===d.BOTTOMRIGHT?-(1*Math.PI)/4:1*Math.PI/4,this.panZoom.scale,5),ex(this.ctx,t===d.TOPLEFT||t===d.BOTTOMRIGHT?s.x+(a-this.extendArrowPadding*Math.sqrt(2))*this.panZoom.scale:s.x+this.extendArrowPadding*Math.sqrt(2)*this.panZoom.scale,s.y+(i-this.extendArrowPadding*Math.sqrt(2))*this.panZoom.scale,t===d.TOPLEFT||t===d.BOTTOMRIGHT?3*Math.PI/4:-(3*Math.PI)/4,this.panZoom.scale,5),t){case d.TOPLEFT:this.topLeftButtonDimensions={x:n.x,y:n.y,width:a,height:i};break;case d.TOPRIGHT:this.topRightButtonDimensions={x:n.x,y:n.y,width:a,height:i};break;case d.BOTTOMLEFT:this.bottomLeftButtonDimensions={x:n.x,y:n.y,width:a,height:i};break;case d.BOTTOMRIGHT:this.bottomRightButtonDimensions={x:n.x,y:n.y,width:a,height:i}}}drawSurroundingDashedLines(e){let t=15*this.panZoom.scale,r=this.ctx;r.save();let i=5*this.panZoom.scale,a=5*this.panZoom.scale;r.setLineDash([i,a]),r.strokeStyle="#333333",r.lineWidth=1;let s=this.gridSquareLength*this.panZoom.scale;r.beginPath(),r.moveTo(e.x-t,e.y-t),r.lineTo(e.x+this.columnCount*s+t,e.y-t),r.lineTo(e.x+this.columnCount*s+t,e.y+this.rowCount*s+t),r.lineTo(e.x-t,e.y+this.rowCount*s+t),r.lineTo(e.x-t,e.y-t),r.stroke(),r.restore()}drawCircleButtonAlongDashedLine(e){let t=15*this.panZoom.scale,r=this.ctx,i=this.gridSquareLength*this.panZoom.scale,a={x:e.x-t,y:e.y-t},s=3*this.panZoom.scale,n={x:e.x+this.columnCount*i/2,y:e.y-t},o={x:e.x+this.columnCount*i+t,y:e.y-t},l={x:e.x+this.columnCount*i+t,y:e.y+this.rowCount*i/2},d={x:e.x+this.columnCount*i+t,y:e.y+this.rowCount*i+t},h={x:e.x+this.columnCount*i/2,y:e.y+this.rowCount*i+t},u={x:e.x-t,y:e.y+this.rowCount*i+t},c={x:e.x-t,y:e.y+this.rowCount*i/2};[a,n,o,l,d,h,u,c].forEach(e=>em(r,e,s,"#ffffff","#5A7FF7",1))}drawButtons(e){let t="transparent",r="rgba(50,50,50,0.4)";this.drawTopButton(this.hoveredButton===d.TOP?r:t,e),this.drawBottomButton(this.hoveredButton===d.BOTTOM?r:t,e),this.drawLeftButton(this.hoveredButton===d.LEFT?r:t,e),this.drawRightButton(this.hoveredButton===d.RIGHT?r:t,e),[d.TOPLEFT,d.TOPRIGHT,d.BOTTOMLEFT,d.BOTTOMRIGHT].forEach(i=>this.drawDiagonalButtons(this.hoveredButton===i?r:t,i,e))}renderSelection(e){let t=this.ctx,{startWorldPos:r,endWorldPos:i}=e,a=b(this.element,r,this.dpr),s=b(this.element,i,this.dpr),n=M(a,this.panZoom),o=M(s,this.panZoom);t.save(),t.beginPath(),t.moveTo(n.x,n.y),t.lineTo(o.x,n.y),t.lineTo(o.x,o.y),t.lineTo(n.x,o.y),t.lineTo(n.x,n.y),t.closePath(),t.strokeStyle="#fc933c",t.lineWidth=5,t.stroke(),t.restore()}render(){let e=this.ctx;e.clearRect(0,0,this.width,this.height);let t=this.gridSquareLength*this.panZoom.scale,r={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength},i=b(this.element,r,this.dpr),a=M(i,this.panZoom);if(this.isGridFixed||(this.drawButtons(r),this.drawSurroundingDashedLines(a),this.drawCircleButtonAlongDashedLine(a)),this.isGridVisible){e.save(),e.lineWidth=this.gridStrokeWidth,e.strokeStyle=this.gridStrokeColor;for(let r=0;r<=this.columnCount;r++)(0===r||r===this.columnCount)&&(e.beginPath(),e.moveTo(a.x+r*t,a.y-this.gridStrokeWidth/2),e.lineTo(a.x+r*t,a.y+this.rowCount*t+this.gridStrokeWidth/2),e.stroke(),e.closePath()),e.beginPath(),e.moveTo(a.x+r*t,a.y),e.lineTo(a.x+r*t,a.y+this.rowCount*t),e.stroke(),e.closePath();for(let r=0;r<=this.rowCount;r++)(0===r||r===this.rowCount)&&(e.beginPath(),e.moveTo(a.x-this.gridStrokeWidth/2,a.y+r*t),e.lineTo(a.x+this.columnCount*t+this.gridStrokeWidth/2,a.y+r*t),e.stroke(),e.closePath()),e.beginPath(),e.moveTo(a.x,a.y+r*t),e.lineTo(a.x+this.columnCount*t,a.y+r*t),e.stroke(),e.closePath();e.restore()}}}function eI(e,t){return`${e}*${t}`}(s=u||(u={})).DATA_CHANGE="dataChange",s.GRID_CHANGE="gridChange",s.STROKE_END="strokeEnd",s.BRUSH_CHANGE="brushChange",s.HOVER_PIXEL_CHANGE="hoverPixelChange",s.LAYER_CHANGE="layerChange",s.CANVAS_INFO_CHANGE="canvasInfoChange",(n=c||(c={})).DOT="DOT",n.ERASER="ERASER",n.PAINT_BUCKET="PAINT_BUCKET",n.SELECT="SELECT",n.NONE="NONE",(o=g||(g={}))[o.FILL=1]="FILL",o[o.EMPTY=0]="EMPTY";class ep{constructor(){this.rawChanges=[],this.effectiveChangesMap=new Map}record(e){if(this.rawChanges.length>0){let t=this.rawChanges[this.rawChanges.length-1];t.rowIndex===e.rowIndex&&t.columnIndex===e.columnIndex&&t.color===e.color&&t.previousColor===e.previousColor||this.rawChanges.push(e)}else this.rawChanges.push(e);let{rowIndex:t,columnIndex:r,color:i,previousColor:a}=e,s=eI(t,r);if(this.effectiveChangesMap.has(s)){let e=this.effectiveChangesMap.get(s).previousColor;this.effectiveChangesMap.set(s,{color:i,previousColor:e})}else this.effectiveChangesMap.set(s,{color:i,previousColor:a})}reset(){this.rawChanges=[],this.effectiveChangesMap=new Map}getIsChanged(){return this.effectiveChangesMap.size>0}getRawChanges(){return this.rawChanges}getEffectiveChanges(){let e=[];return this.effectiveChangesMap.forEach((t,r)=>{let{rowIndex:i,columnIndex:a}=function(e){let[t,r]=e.split("*");return{rowIndex:parseInt(t),columnIndex:parseInt(r)}}(r);e.push({rowIndex:i,columnIndex:a,color:t.color,previousColor:t.previousColor})}),e}}class eC extends eh{constructor({columnCount:e,rowCount:t,canvas:r}){super({canvas:r}),this.strokedPixelRecords=new Map,this.erasedPixelRecords=new Map,this.tempStrokedPixels=[],this.indicatorPixels=[],this.backgroundColor=I,this.defaultPixelColor=p,this.backgroundMode="color",this.selectingArea=null,this.brushPattern=[[g.FILL]],this.selectedArea=null,this.directionToExtendSelectedArea=null,this.movingSelectedArea=null,this.movingSelectedPixels=null,this.extendingSelectedArea=null,this.extendingSelectedPixels=[],this.capturedBaseExtendingSelectedArea=null,this.capturedBaseExtendingSelectedAreaPixels=null,this.selectedAreaPixels=null,this.capturedData=null,this.capturedDataOriginalIndices=null,this.hoveredPixel=null,this.gridSquareLength=20,this.minimumCount=2,this.dataLayerColumnCount=e,this.dataLayerRowCount=t}getCapturedData(){return this.capturedData}getDirectionToExtendSelectedArea(){return this.directionToExtendSelectedArea}getCapturedDataOriginalIndices(){return this.capturedDataOriginalIndices}getBrushPattern(){return this.brushPattern}setBrushPattern(e){this.brushPattern=e}setGridSquareLength(e){this.gridSquareLength=e}setDefaultPixelColor(e){this.defaultPixelColor=e}setDataLayerColumnCount(e){this.dataLayerColumnCount=e}setDataLayerRowCount(e){this.dataLayerRowCount=e}setDirectionToExtendSelectedArea(e){this.directionToExtendSelectedArea=e}setSelectedArea(e){this.selectedArea=e}setSelectingArea(e){this.selectingArea=e}setMovingSelectedPixels(e){this.movingSelectedPixels=e}setMovingSelectedArea(e){this.movingSelectedArea=e}setExtendingSelectedPixels(e){this.extendingSelectedPixels=e}setExtendingSelectedArea(e){this.extendingSelectedArea=e}setSelectedAreaPixels(e){this.selectedAreaPixels=e}setBackgroundColor(e){this.backgroundColor=e||I}setCapturedData(e){for(let t of(this.capturedData=new Map,Array.from(e.entries()))){let[e,r]=t;this.capturedData.set(e,new Map(r))}this.capturedDataOriginalIndices=X(e)}setCapturedBaseExtendingSelectedArea(e){this.capturedBaseExtendingSelectedArea=e}setCapturedBaseExtendingSelectedAreaPixels(e){this.capturedBaseExtendingSelectedAreaPixels=e}resetCapturedData(){this.capturedData=null,this.capturedDataOriginalIndices=null,this.deleteStrokePixelRecord(f)}getHoveredPixel(){return this.hoveredPixel}getMovingSelectedPixels(){return this.movingSelectedPixels}getMovingSelectedArea(){return this.movingSelectedArea}getExtendingSelectedArea(){return this.extendingSelectedArea}getExtendingSelectedPixels(){return this.extendingSelectedPixels}setHoveredPixel(e){this.hoveredPixel=e}getSelectingArea(){return this.selectingArea}getSelectedArea(){return this.selectedArea}getSelectedAreaPixels(){return this.selectedAreaPixels}getStrokedPixelRecords(){return this.strokedPixelRecords}getEffectiveStrokePixelChanges(e){return this.strokedPixelRecords.has(e)?this.strokedPixelRecords.get(e).getEffectiveChanges():[]}getErasedPixelRecords(){return this.erasedPixelRecords}getEffectiveEraserPixelChanges(e){return this.erasedPixelRecords.has(e)?this.erasedPixelRecords.get(e).getEffectiveChanges():[]}getIndicatorPixels(){return this.indicatorPixels}getMinimumCount(){return this.minimumCount}detectSelectedAreaExtendDirection(e){if(!this.selectedArea)return null;let t=6+-(6*((this.panZoom.scale-1.5)/1.2)),r=6+-(6*((this.panZoom.scale-1.5)/1.2)),i=e.x,a=e.y,s=this.selectedArea.endWorldPos.x-this.selectedArea.startWorldPos.x,n=this.selectedArea.endWorldPos.y-this.selectedArea.startWorldPos.y,o={x:this.selectedArea.startWorldPos.x,y:this.selectedArea.startWorldPos.y,width:s,height:t},l={x:this.selectedArea.startWorldPos.x,y:this.selectedArea.endWorldPos.y,width:s,height:t},h={x:this.selectedArea.startWorldPos.x,y:this.selectedArea.startWorldPos.y,width:r,height:n},u={x:this.selectedArea.endWorldPos.x,y:this.selectedArea.startWorldPos.y,width:r,height:n},c=h.width;if(i>=o.x+c&&i<=o.x+o.width-c&&a>=o.y-c&&a<=o.y+c)return d.TOP;if(i>=l.x+c&&i<=l.x+l.width-c&&a>=l.y-c&&a<=l.y+c)return d.BOTTOM;if(i>=h.x-c&&i<=h.x+c&&a>=h.y+c&&a<=h.y+h.height-c)return d.LEFT;if(i>=u.x-c&&i<=u.x+c&&a>=u.y+c&&a<=u.y+u.height-c)return d.RIGHT;if(i>=o.x-c&&i<=o.x+c&&a>=o.y-c&&a<=o.y+c)return d.TOPLEFT;if(i>=u.x-c&&i<=u.x+c&&a>=u.y-c&&a<=u.y+c)return d.TOPRIGHT;if(i>=l.x-c&&i<=l.x+c&&a>=l.y-c&&a<=l.y+c)return d.BOTTOMLEFT;else if(i>=u.x-c&&i<=u.x+c&&a>=l.y-c&&a<=l.y+c)return d.BOTTOMRIGHT;else return null}extendSelectedAreaSideWays(e,t,r){let i=this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex-this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,a=this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex-this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,s={rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex+(i+2)/2,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex+(a+2)/2},n=1,o=1,l=e===d.TOP?this.capturedBaseExtendingSelectedArea.startWorldPos.y-t.y:e===d.BOTTOM?t.y-this.capturedBaseExtendingSelectedArea.endWorldPos.y:0,h=e===d.LEFT?this.capturedBaseExtendingSelectedArea.startWorldPos.x-t.x:e===d.RIGHT?t.x-this.capturedBaseExtendingSelectedArea.endWorldPos.x:0;if(r){let e=(i+1)%2==0,t=(a+1)%2==0,r=Math.round(l/this.gridSquareLength),s=Math.round(h/this.gridSquareLength),d=i+1+2*r;d<1&&!e?(d=1,r=-i/2):d<2&&e&&(d=2,r=-(i-1)/2);let u=a+1+2*s;u<1&&!t?(u=1,s=-a/2):u<2&&t&&(u=2,s=-(a-1)/2),o=(i+2*r)/i,n=(a+2*s)/a,this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x-s*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y-r*this.gridSquareLength},endWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x+s*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y+r*this.gridSquareLength},startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex-r,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex-s},endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex+r,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex+s}})}else{let r=e===d.TOP?this.capturedBaseExtendingSelectedArea.startWorldPos.y-t.y:e===d.BOTTOM?t.y-this.capturedBaseExtendingSelectedArea.endWorldPos.y:0,l=e===d.LEFT?this.capturedBaseExtendingSelectedArea.startWorldPos.x-t.x:e===d.RIGHT?t.x-this.capturedBaseExtendingSelectedArea.endWorldPos.x:0,h=Math.round(r/this.gridSquareLength),u=Math.round(l/this.gridSquareLength),c=i+1+h,g=a+1+u;c<1&&(c=1,h=-i),g<1&&(g=1,u=-a),o=c/(i+1),n=g/(a+1),e===d.TOP?(s.rowIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y-c*this.gridSquareLength},endWorldPos:this.capturedBaseExtendingSelectedArea.endWorldPos,startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex-c+1,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex},endPixelIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex})):e===d.BOTTOM?(s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,o=c/(i+1),this.setExtendingSelectedArea({startWorldPos:this.capturedBaseExtendingSelectedArea.startWorldPos,endWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y+c*this.gridSquareLength},startPixelIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex,endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex+c-1,columnIndex:this.selectedArea.endPixelIndex.columnIndex}})):e===d.LEFT?(s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex,n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x-g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y},endWorldPos:this.capturedBaseExtendingSelectedArea.endWorldPos,startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex-g+1},endPixelIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex})):e===d.RIGHT&&(s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:this.capturedBaseExtendingSelectedArea.startWorldPos,endWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x+g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y},startPixelIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex,endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex+g-1}}))}let u=j(this.capturedBaseExtendingSelectedAreaPixels,s,n,o,this.gridSquareLength).filter(e=>!(e.columnIndex<this.extendingSelectedArea.startPixelIndex.columnIndex||e.columnIndex>this.extendingSelectedArea.endPixelIndex.columnIndex||e.rowIndex<this.extendingSelectedArea.startPixelIndex.rowIndex||e.rowIndex>this.extendingSelectedArea.endPixelIndex.rowIndex));this.setExtendingSelectedPixels(u)}extendSelectedAreaDiagonally(e,t,r){if(!this.selectedArea||!this.capturedBaseExtendingSelectedArea)return;let i=this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex-this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,a=this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex-this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,s={rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex},n=1,o=1;if(r){let r=(i+1)%2==0,l=(a+1)%2==0;s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex+(i+2)/2,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex+(a+2)/2;let h=e===d.TOPLEFT||e===d.TOPRIGHT?this.capturedBaseExtendingSelectedArea.startWorldPos.y-t.y:t.y-this.capturedBaseExtendingSelectedArea.endWorldPos.y,u=e===d.TOPLEFT||e===d.BOTTOMLEFT?this.capturedBaseExtendingSelectedArea.startWorldPos.x-t.x:t.x-this.capturedBaseExtendingSelectedArea.endWorldPos.x,c=Math.round(h/this.gridSquareLength),g=Math.round(u/this.gridSquareLength),x=i+1+2*c;x<1&&!r?(x=1,c=-i/2):x<2&&r&&(x=2,c=-(i-1)/2);let y=a+1+2*g;y<1&&!l?(y=1,g=-a/2):y<2&&l&&(y=2,g=-(a-1)/2),o=(i+2*c)/i,n=(a+2*g)/a,this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x-g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y-c*this.gridSquareLength},endWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x+g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y+c*this.gridSquareLength},startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex-c,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex-g},endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex+c,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex+g}})}else{let r=e===d.TOPLEFT||e===d.TOPRIGHT?this.capturedBaseExtendingSelectedArea.startWorldPos.y-t.y:t.y-this.capturedBaseExtendingSelectedArea.endWorldPos.y,l=e===d.TOPLEFT||e===d.BOTTOMLEFT?this.capturedBaseExtendingSelectedArea.startWorldPos.x-t.x:t.x-this.capturedBaseExtendingSelectedArea.endWorldPos.x,h=Math.round(r/this.gridSquareLength),u=Math.round(l/this.gridSquareLength),c=i+1+h,g=a+1+u;c<1&&(c=1,h=-i),g<1&&(g=1,u=-a),e===d.TOPLEFT?(s.rowIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex,o=c/(i+1),n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x-g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y-c*this.gridSquareLength},endWorldPos:this.capturedBaseExtendingSelectedArea.endWorldPos,startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex-c+1,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex-g+1},endPixelIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex})):e===d.TOPRIGHT?(s.rowIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,o=c/(i+1),n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y-c*this.gridSquareLength},endWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x+g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.endWorldPos.y},startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex-c+1,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex},endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex+g-1}})):e===d.BOTTOMLEFT?(s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex,o=c/(i+1),n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x-g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y},endWorldPos:{x:this.capturedBaseExtendingSelectedArea.endWorldPos.x,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y+c*this.gridSquareLength},startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex-g+1},endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex+c-1,columnIndex:this.capturedBaseExtendingSelectedArea.endPixelIndex.columnIndex}})):e===d.BOTTOMRIGHT&&(s.rowIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,s.columnIndex=this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex,o=c/(i+1),n=g/(a+1),this.setExtendingSelectedArea({startWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y},endWorldPos:{x:this.capturedBaseExtendingSelectedArea.startWorldPos.x+g*this.gridSquareLength,y:this.capturedBaseExtendingSelectedArea.startWorldPos.y+c*this.gridSquareLength},startPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex},endPixelIndex:{rowIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.rowIndex+c-1,columnIndex:this.capturedBaseExtendingSelectedArea.startPixelIndex.columnIndex+g-1}}))}let l=j(this.capturedBaseExtendingSelectedAreaPixels,s,n,o,this.gridSquareLength).filter(e=>!(e.columnIndex<this.extendingSelectedArea.startPixelIndex.columnIndex||e.columnIndex>this.extendingSelectedArea.endPixelIndex.columnIndex||e.rowIndex<this.extendingSelectedArea.startPixelIndex.rowIndex||e.rowIndex>this.extendingSelectedArea.endPixelIndex.rowIndex));this.setExtendingSelectedPixels(l)}extendSelectedArea(e,t,r){if(this.selectedArea)switch(null===this.capturedBaseExtendingSelectedArea&&(this.capturedBaseExtendingSelectedArea=this.selectedArea),null===this.capturedBaseExtendingSelectedAreaPixels&&(this.capturedBaseExtendingSelectedAreaPixels=[...this.selectedAreaPixels]),e){case d.TOP:this.extendSelectedAreaSideWays(d.TOP,t,r);break;case d.BOTTOM:this.extendSelectedAreaSideWays(d.BOTTOM,t,r);break;case d.LEFT:this.extendSelectedAreaSideWays(d.LEFT,t,r);break;case d.RIGHT:this.extendSelectedAreaSideWays(d.RIGHT,t,r);break;case d.TOPLEFT:this.extendSelectedAreaDiagonally(d.TOPLEFT,t,r);break;case d.TOPRIGHT:this.extendSelectedAreaDiagonally(d.TOPRIGHT,t,r);break;case d.BOTTOMLEFT:this.extendSelectedAreaDiagonally(d.BOTTOMLEFT,t,r);break;case d.BOTTOMRIGHT:this.extendSelectedAreaDiagonally(d.BOTTOMRIGHT,t,r)}}extendCapturedData(e){if(!this.capturedData)throw Error("There is no captured data");let{topRowIndex:t,bottomRowIndex:r,leftColumnIndex:i,rightColumnIndex:a}=X(this.capturedData);if(e===d.TOP||e===d.BOTTOM){let i=e===d.TOP?t-1:r+1;ei(this.capturedData,i,this.defaultPixelColor)}else if(e===d.LEFT||e===d.RIGHT){let t=e===d.LEFT?i-1:a+1;ea(this.capturedData,t,this.defaultPixelColor)}}shortenCapturedData(e){if(!this.capturedData)throw Error("There is no captured data");let{topRowIndex:t,bottomRowIndex:r,leftColumnIndex:i,rightColumnIndex:a}=X(this.capturedData),s=$(this.capturedData),n=J(this.capturedData),o=[];if(e===d.TOP||e===d.BOTTOM){if(n<=this.minimumCount)return!1;let i=e===d.TOP?t:r,a=Q(this.capturedData,i);o.push(...a),et(this.capturedData,i)}else if(e===d.LEFT||e===d.RIGHT){if(s<=this.minimumCount)return!1;let t=e===d.LEFT?i:a,r=ee(this.capturedData,t);o.push(...r),er(this.capturedData,t)}return!0}setIndicatorPixels(e){Array.isArray(e)&&(this.indicatorPixels=e)}addToStrokePixelRecords(e,t){var r;this.strokedPixelRecords.has(e)||this.strokedPixelRecords.set(e,new ep),null===(r=this.strokedPixelRecords.get(e))||void 0===r||r.record(t)}getAllStrokePixels(){let e=[];return this.strokedPixelRecords.forEach(t=>{e.push(...t.getEffectiveChanges())}),e}addToErasedPixelRecords(e,t){var r;this.erasedPixelRecords.has(e)||this.erasedPixelRecords.set(e,new ep),null===(r=this.erasedPixelRecords.get(e))||void 0===r||r.record(t)}getAllErasedPixels(){let e=[];return this.erasedPixelRecords.forEach(t=>{e.push(...t.getEffectiveChanges())}),e}deleteErasedPixelRecord(e){this.erasedPixelRecords.delete(e)}deleteStrokePixelRecord(e){this.strokedPixelRecords.delete(e)}colorPixels(e){this.tempStrokedPixels.push(...e)}erasePixels(e){this.tempStrokedPixels.push(...e.map(e=>Object.assign(Object.assign({},e),{color:""})))}renderStrokedPixels(e,t){let r=this.ctx,i=null!==this.capturedData,a=this.getAllStrokePixels().filter(e=>{if(!i)return!0;{let t=X(this.capturedData);return e.rowIndex<t.topRowIndex||e.rowIndex>t.bottomRowIndex||e.columnIndex<t.leftColumnIndex||e.columnIndex>t.rightColumnIndex}}),s=this.tempStrokedPixels.filter(e=>""!==e.color).filter(e=>{if(!i)return!0;{let t=X(this.capturedData);return e.rowIndex<t.topRowIndex||e.rowIndex>t.bottomRowIndex||e.columnIndex<t.leftColumnIndex||e.columnIndex>t.rightColumnIndex}});for(let i of(r.save(),a)){let a=this.rowKeyOrderMap.get(i.rowIndex),s=this.columnKeyOrderMap.get(i.columnIndex);void 0!==a&&void 0!==s&&(r.fillStyle=i.color,r.fillRect(s*t+e.x,a*t+e.y,t,t))}for(let i of s){let a=this.rowKeyOrderMap.get(i.rowIndex),s=this.columnKeyOrderMap.get(i.columnIndex);void 0!==a&&void 0!==s&&(r.fillStyle=i.color,r.fillRect(s*t+e.x,a*t+e.y,t,t))}r.restore()}renderErasedPixels(e,t){let r=this.tempStrokedPixels.filter(e=>""==e.color),i=this.getAllErasedPixels(),a=this.ctx;for(let r of(a.save(),i)){let i=this.rowKeyOrderMap.get(r.rowIndex),s=this.columnKeyOrderMap.get(r.columnIndex);void 0!==i&&void 0!==s&&a.clearRect(s*t+e.x,i*t+e.y,t,t)}for(let i of r){let r=this.rowKeyOrderMap.get(i.rowIndex),s=this.columnKeyOrderMap.get(i.columnIndex);void 0!==r&&void 0!==s&&a.clearRect(s*t+e.x,r*t+e.y,t,t)}}renderMovingSelectedPixels(e,t){if(null===this.movingSelectedPixels||0==this.movingSelectedPixels.length)return;let r=this.ctx;for(let i of(r.save(),this.movingSelectedPixels)){let a=i.previousColor;r.fillStyle=a;let s=this.rowKeyOrderMap.get(i.rowIndex),n=this.columnKeyOrderMap.get(i.columnIndex);void 0!==s&&void 0!==n&&r.fillRect(n*t+e.x,s*t+e.y,t,t)}r.restore()}renderExtendingSelectedPixels(e,t){if(null===this.extendingSelectedPixels||0==this.extendingSelectedPixels.length)return;let r=this.ctx;for(let i of(r.save(),this.extendingSelectedPixels)){let a=i.previousColor;r.fillStyle=a;let s=this.rowKeyOrderMap.get(i.rowIndex),n=this.columnKeyOrderMap.get(i.columnIndex);void 0!==s&&void 0!==n&&r.fillRect(n*t+e.x,s*t+e.y,t,t)}r.restore()}renderCanvasMask(e,t){if(null===this.capturedData||null===this.capturedDataOriginalIndices)return;let r=X(this.capturedData),i=this.capturedDataOriginalIndices,a=r.rightColumnIndex-r.leftColumnIndex+1,s=r.bottomRowIndex-r.topRowIndex+1,n=r.leftColumnIndex-i.leftColumnIndex,o=r.rightColumnIndex-i.rightColumnIndex,l=r.topRowIndex-i.topRowIndex,d=r.bottomRowIndex-i.bottomRowIndex,h=this.ctx;n>0?eL(h,e.x-n*t,e.y,n*t,s*t,this.backgroundColor,this.backgroundColor,1):eL(h,e.x,e.y,-n*t,s*t,this.defaultPixelColor,this.defaultPixelColor,1),o>0?eL(h,e.x+a*t-o*t,e.y,o*t,s*t,this.defaultPixelColor,this.defaultPixelColor,1):eL(h,e.x+a*t,e.y,-o*t,s*t,this.backgroundColor,this.backgroundColor,1),l>0?eL(h,e.x,e.y-l*t,a*t,l*t,this.backgroundColor,this.backgroundColor,1):eL(h,e.x,e.y,a*t,-l*t,this.defaultPixelColor,this.defaultPixelColor,1),d>0?eL(h,e.x,e.y+s*t-d*t,a*t,d*t,this.defaultPixelColor,this.defaultPixelColor,1):eL(h,e.x,e.y+s*t,a*t,-d*t,this.backgroundColor,this.backgroundColor,1),n>0&&l>0&&eL(h,e.x-n*t,e.y-l*t,n*t,l*t,this.backgroundColor,this.backgroundColor,1),n>0&&d<0&&eL(h,e.x-n*t,e.y+s*t,n*t,-d*t,this.backgroundColor,this.backgroundColor,1),o<0&&l>0&&eL(h,e.x+a*t,e.y-l*t,-o*t,l*t,this.backgroundColor,this.backgroundColor,1),o<0&&d<0&&eL(h,e.x+a*t,e.y+s*t,-o*t,-d*t,this.backgroundColor,this.backgroundColor,1)}renderIndicatorPixels(e,t){if(0==this.indicatorPixels.length)return;let r=this.ctx;for(let i of(r.save(),this.indicatorPixels)){r.fillStyle=i.color,r.globalAlpha=.5;let a=this.rowKeyOrderMap.get(i.rowIndex),s=this.columnKeyOrderMap.get(i.columnIndex);void 0!==a&&void 0!==s&&(r.clearRect(s*t+e.x,a*t+e.y,t,t),r.fillRect(s*t+e.x,a*t+e.y,t,t))}r.restore()}renderHoveredPixel(e,t){if(null===this.hoveredPixel)return;let r=this.ctx,{rowIndex:i,columnIndex:a}=this.hoveredPixel,s=this.rowKeyOrderMap.get(i),n=this.columnKeyOrderMap.get(a);if(void 0===s||void 0===n)return;let o=this.brushPattern.length,l=this.brushPattern[0].length,d=Math.floor(l/2),h=Math.floor(o/2);r.save(),r.globalAlpha=.5;for(let s=0;s<l;s++)for(let n=0;n<o;n++){let o=this.brushPattern[s][n];if(0===o)continue;let l=this.rowKeyOrderMap.get(i+s-d),u=this.columnKeyOrderMap.get(a+n-h);void 0!==l&&void 0!==u&&(r.fillStyle=this.hoveredPixel.color,r.fillRect(u*t+e.x,l*t+e.y,t,t))}r.restore()}render(){let e=this.gridSquareLength*this.panZoom.scale,t={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength},r=b(this.element,t,this.dpr),i=M(r,this.panZoom),a=this.ctx;a.clearRect(0,0,this.width,this.height),this.renderCanvasMask(i,e),this.renderStrokedPixels(i,e),this.renderErasedPixels(i,e),this.renderIndicatorPixels(i,e),this.renderHoveredPixel(i,e),this.renderMovingSelectedPixels(i,e),this.renderExtendingSelectedPixels(i,e)}}(l=x||(x={})).ColorChange="ColorChange",l.ColorSizeChange="ColorSizeChange",l.SelectAreaMove="SelectAreaMove",l.LayerCreate="LayerCreate",l.LayerDelete="LayerDelete",l.LayerOrderChange="LayerOrderChange";class eP{getType(){return this.type}getLayerId(){return this.layerId}}class eS extends eP{constructor(e,t){super(),this.type=x.ColorChange,this.data=e,this.layerId=t}createInverseAction(){return new eS(this.data.map(e=>Object.assign(Object.assign({},e),{previousColor:e.color,color:e.previousColor})),this.layerId)}}class ew extends eP{constructor(e,t,r,i,a,s){super(),this.type=x.ColorSizeChange,this.data=e,this.rowIndicesToDelete=new Set(i),this.columnIndicesToDelete=new Set(a),this.rowIndicesToAdd=new Set(t),this.columnIndicesToAdd=new Set(r),this.layerId=s}createInverseAction(){return new ew(this.data,Array.from(this.rowIndicesToDelete),Array.from(this.columnIndicesToDelete),Array.from(this.rowIndicesToAdd),Array.from(this.columnIndicesToAdd),this.layerId)}}class eA extends eP{constructor(e,t,r){super(),this.type=x.LayerCreate,this.layerId=e,this.layer=t,this.insertIndex=r}createInverseAction(){return new eE(this.layerId,this.layer,this.insertIndex)}}class eE extends eP{constructor(e,t,r){super(),this.type=x.LayerDelete,this.layerId=e,this.layer=t,this.removeIndex=r}createInverseAction(){return new eA(this.layerId,this.layer,this.removeIndex)}}class eT extends eP{constructor(e,t){super(),this.type=x.LayerOrderChange,this.layerId=null,this.previousLayerIds=e,this.reorderdLayerIds=t}createInverseAction(){return new eT(this.reorderdLayerIds,this.previousLayerIds)}}class ev extends eP{constructor(e,t,r,i){super(),this.type=x.SelectAreaMove,this.tool=c.SELECT,this.data=e,this.previousSelectedArea=t,this.newSelectedArea=r,this.layerId=i}createInverseAction(){return new ev(this.data.map(e=>Object.assign(Object.assign({},e),{previousColor:e.color,color:e.previousColor})),this.newSelectedArea,this.previousSelectedArea,this.layerId)}}class Event{constructor(e){this.name=e,this.callbacks=[]}on(e){this.callbacks.push(e)}off(e){let t=this.callbacks.findIndex(t=>t===e);this.callbacks.splice(t,1)}toString(){return this.name}}class eD{constructor(){this.events={}}emit(e,...t){this.events[e]&&this.events[e].callbacks.forEach(e=>{e(...t)})}addEventListener(e,t){this.events[e]||(this.events[e]=new Event(e)),this.events[e].on(t)}removeEventListener(e,t){if(!t){delete this.events[e];return}this.events[e].off(t)}}class eb{constructor(e){this.data=e,this.next=null}}class eR{constructor(){this.head=null,this.tail=null,this.length=0}enqueue(e){let t=new eb(e);0===this.length?this.head=t:this.tail.next=t,this.tail=t,this.length++}dequeue(){if(0===this.length)return null;let e=this.head.data;return this.head=this.head.next,this.length--,e}size(){return this.length}isEmpty(){return 0===this.length}clear(){this.head=null,this.tail=null,this.length=0}}function eB(e,t,r,i){return e.addEventListener(t,r,i)}function eM(e,t,r,i){return e.removeEventListener(t,r,i)}let eO={mouseup:"touchend",mouseout:"touchend",mousedown:"touchstart",mousemove:"touchmove"};function ek(e,t,r,i){t(e,eO[r],i),t(e,r,i)}class eG extends eD{constructor({gridCanvas:e,interactionCanvas:t,dataCanvas:r,backgroundCanvas:i,foregroundCanvas:a,initLayers:s,gridSquareLength:n,width:o,height:l,initAutoScale:u,dpr:g}){super(),this.zoomSensitivity=200,this.maxScale=1.5,this.minScale=.05,this.extensionAllowanceRatio=2,this.pinchZoomDiff=null,this.originalLayerIdsInOrderForHistory=[],this.lastRenderAllCall=null,this.panZoom={scale:1,offset:{x:0,y:0}},this.panPoint={lastMousePos:{x:0,y:0}},this.dpr=1,this.brushColor="#FF0000",this.gridSquareLength=20,this.maxHistoryCount=100,this.undoHistory=[],this.redoHistory=[],this.extensionPoint={direction:null},this.isPanZoomable=!0,this.isAltPressed=!1,this.mouseMode=h.NULL,this.brushTool=c.DOT,this.mouseDownWorldPos=null,this.mouseDownPanZoom=null,this.mouseMoveWorldPos={x:0,y:0},this.previousMouseMoveWorldPos=null,this.renderDataLayerTimeout=null,this.isDrawingEnabled=!0,this.isInteractionApplicable=!0,this.styleMouseCursor=e=>{let t=this.detectButtonClicked(e);if(this.mouseMode===h.EXTENDING&&(t=this.extensionPoint.direction),t)switch(t){case d.TOP:case d.BOTTOM:this.element.style.cursor="ns-resize";break;case d.LEFT:case d.RIGHT:this.element.style.cursor="ew-resize";break;case d.TOPLEFT:this.element.style.cursor="nw-resize";break;case d.TOPRIGHT:this.element.style.cursor="ne-resize";break;case d.BOTTOMLEFT:this.element.style.cursor="sw-resize";break;case d.BOTTOMRIGHT:this.element.style.cursor="se-resize"}else switch(this.brushTool){case c.DOT:case c.ERASER:case c.PAINT_BUCKET:this.element.style.cursor="crosshair";break;case c.SELECT:this.element.style.cursor="crosshair";let r=this.interactionLayer.getSelectedArea();if(r){let t=this.interactionLayer.detectSelectedAreaExtendDirection(e);if(t)switch(t){case d.TOP:case d.BOTTOM:this.element.style.cursor="ns-resize";break;case d.LEFT:case d.RIGHT:this.element.style.cursor="ew-resize";break;case d.TOPLEFT:this.element.style.cursor="nw-resize";break;case d.TOPRIGHT:this.element.style.cursor="ne-resize";break;case d.BOTTOMLEFT:this.element.style.cursor="sw-resize";break;case d.BOTTOMRIGHT:this.element.style.cursor="se-resize"}else{let t=q(e,r);t&&(this.element.style.cursor="grab")}}break;default:this.element.style.cursor="default"}},this.handleExtension=e=>{e.preventDefault();let t=this.interactionLayer,r=t.getCapturedData();r||(t.setCapturedData(this.dataLayer.getCopiedData()),r=t.getCapturedData());let i=this.dataLayer.getRowCount(),a=this.dataLayer.getColumnCount(),s=this.gridSquareLength;if(window.TouchEvent&&e instanceof TouchEvent&&e.touches.length>1)return;let n=this.mouseDownPanZoom,o=H(e,this.element,n,this.dpr),l=this.extensionPoint.direction,h=R(this.mouseDownWorldPos,o),u=h.y>0?Math.floor(h.y/s):Math.ceil(h.y/s),c=h.x>0?Math.floor(h.x/s):Math.ceil(h.x/s);if(0==Math.abs(u)&&0==Math.abs(c))return;let g=l===d.TOP||l===d.TOPLEFT||l===d.TOPRIGHT?i+u:i-u,x=l===d.TOPLEFT||l===d.BOTTOMLEFT||l===d.LEFT?a+c:a-c,y=J(r),m=$(r),L=t.getMinimumCount();if(l){let e=!(l===d.LEFT||l===d.RIGHT),t=!(l===d.TOP||l===d.BOTTOM);e&&(g>y?this.extendInteractionGridBy(l,{x:0,y:g-y}):g>=L?this.shortenInteractionGridBy(l,{x:0,y:y-g}):this.shortenInteractionGridBy(l,{x:0,y:y-L})),t&&(x>m?this.extendInteractionGridBy(l,{x:x-m,y:0}):x>=L?this.shortenInteractionGridBy(l,{x:m-x,y:0}):this.shortenInteractionGridBy(l,{x:m-L,y:0})),this.interactionLayer.setCriterionDataForRendering(this.interactionLayer.getCapturedData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}},this.handlePinchZoom=e=>{if(!this.isPanZoomable||this.interactionLayer.getCapturedData())return;let t=F(e,this.element,this.panZoom,this.dpr);if(!t)return;this.panPoint.lastMousePos=t;let r=W(e,this.element,this.panZoom,this.zoomSensitivity,this.pinchZoomDiff,this.minScale,this.maxScale);r&&(this.pinchZoomDiff=r.pinchZoomDiff,this.setPanZoom({scale:r.panZoom.scale,offset:r.panZoom.offset}))},this.handleKeyDown=e=>{"KeyZ"===e.code&&(e.ctrlKey||e.metaKey)&&this.undo(),"KeyY"===e.code&&(e.ctrlKey||e.metaKey)&&this.redo()},this.handleWheel=e=>{if(e.preventDefault(),this.isPanZoomable&&this.mouseMode!==h.EXTENDING){if(e.ctrlKey){let t=1-e.deltaY/this.zoomSensitivity,r=this.panZoom.scale*t;r>this.maxScale&&(r=this.maxScale),r<this.minScale&&(r=this.minScale);let i={x:e.offsetX,y:e.offsetY},a=z(i,this.panZoom,r);this.setPanZoom({scale:r,offset:a})}else{let t=R(this.panZoom.offset,{x:e.deltaX,y:e.deltaY});this.setPanZoom(Object.assign(Object.assign({},this.panZoom),{offset:t}))}}},this.handlePanning=e=>{let t=Object.assign({},this.panPoint.lastMousePos),r=k(e,this.element,this.panZoom),i={x:r.offsetX,y:r.offsetY};this.panPoint.lastMousePos=i;let a=R(t,i),s=R(this.panZoom.offset,a);this.setPanZoom({offset:s})},this.gridSquareLength=n||this.gridSquareLength,this.dataLayer=new eg({canvas:r,layers:s});let x=this.dataLayer.getTopRowIndex(),y=this.dataLayer.getLeftColumnIndex();this.originalLayerIdsInOrderForHistory=this.dataLayer.getLayers().map(e=>e.getId());let m=this.dataLayer.getRowCount(),L=this.dataLayer.getColumnCount();this.gridLayer=new ef({columnCount:L,rowCount:m,canvas:e}),this.interactionLayer=new eC({columnCount:L,rowCount:m,canvas:t}),this.setTopLeftIndices(x,y),this.foregroundCanvasElement=a,this.foregroundCtx=a.getContext("2d"),this.backgroundCanvasElement=i,this.backgroundCtx=i.getContext("2d"),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.element=t,g&&this.scale(g,g),this.setSize(o,l),this.adjustInitialZoomScale({width:L,height:m},!1===u?1:void 0),this.initialize(),this.dataLayer.updateCapturedImageBitmap()}initialize(){this.emit=this.emit.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseOut=this.onMouseOut.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseMove=this.onMouseMove.bind(this),ek(this.element,eB,"mousedown",this.onMouseDown),ek(this.element,eB,"mouseup",this.onMouseUp),ek(this.element,eB,"mouseout",this.onMouseOut),ek(this.element,eB,"mousemove",this.onMouseMove),this.element.addEventListener("wheel",this.handleWheel)}adjustInitialZoomScale(e,t){let{width:r,height:i}=e,a=r*this.gridSquareLength,s=this.width,n=i*this.gridSquareLength,o=this.height,l=t||Math.min(s/(a+2*Math.max((s-a)/2,20)),o/(n+2*Math.max((o-n)/2,20))),d={x:0,y:0},h={x:s/2,y:o/2},u=M(h,{scale:1,offset:d}),c=M(h,{scale:l,offset:d}),g=R(u,c);this.setPanZoom({scale:l,offset:{x:g.x-r/2*this.gridSquareLength*l,y:g.y-i/2*this.gridSquareLength*l}})}emitCurrentGridStatus(){let e=this.dataLayer.getData(),t={columnCount:this.getColumnCount(),rowCount:this.getRowCount()},r=X(e);this.emitGridChangeEvent({dimensions:t,indices:r})}emitCurrentHoverPixelStatus(){this.emitHoverPixelChangeEvent({indices:this.interactionLayer.getHoveredPixel()})}emitCurrentData(){this.emitDataChangeEvent({isLocalChange:!1,data:this.dataLayer.getData(),layerId:this.dataLayer.getCurrentLayer().getId()})}emitCurrentBrushTool(){this.emitBrushChangeEvent({brushColor:this.brushColor,brushTool:this.brushTool,brushPattern:this.interactionLayer.getBrushPattern()})}emitCurrentLayerStatus(){this.emitLayerChangeEvent({layers:this.dataLayer.getLayers(),currentLayer:this.dataLayer.getCurrentLayer()})}emitCurrentCanvasInfoStatus(e,t){let r={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength},i=b(this.element,r,this.dpr),a=M(i,this.panZoom),s=this.gridSquareLength*this.panZoom.scale,n=e||this.dataLayer.getColumnCount(),o=t||this.dataLayer.getRowCount();this.emitCanvasInfoChangeEvent({panZoom:this.panZoom,topLeftCornerOffset:a,topRightCornerOffset:{x:a.x+n*s,y:a.y},bottomLeftCornerOffset:{x:a.x,y:a.y+o*s},bottomRightCornerOffset:{x:a.x+n*s,y:a.y+o*s},gridSquareSize:s})}emitCanvasInfoChangeEvent(e){this.emit(u.CANVAS_INFO_CHANGE,e)}emitDataChangeEvent(e){this.emit(u.DATA_CHANGE,e)}emitGridChangeEvent(e){this.emit(u.GRID_CHANGE,e)}emitStrokeEndEvent(e){this.emit(u.STROKE_END,e)}emitHoverPixelChangeEvent(e){this.emit(u.HOVER_PIXEL_CHANGE,e)}emitBrushChangeEvent(e){this.emit(u.BRUSH_CHANGE,e)}emitLayerChangeEvent(e){this.emit(u.LAYER_CHANGE,e)}setBrushPattern(e){this.interactionLayer.setBrushPattern(e),this.emitBrushChangeEvent({brushColor:this.brushColor,brushTool:this.brushTool,brushPattern:this.interactionLayer.getBrushPattern()})}setBackgroundColor(e){this.interactionLayer.setBackgroundColor(e)}setIndicatorPixels(e){this.interactionLayer.setIndicatorPixels(e),this.renderInteractionLayer()}setIsGridFixed(e){this.gridLayer.setIsGridFixed(e),this.renderGridLayer()}setGridStrokeColor(e){this.gridLayer.setGridStrokeColor(e),this.renderGridLayer()}setGridStrokeWidth(e){this.gridLayer.setGridStrokeWidth(e),this.renderGridLayer()}setDefaultPixelColor(e){void 0!==e&&(this.dataLayer.setDefaultPixelColor(e),this.interactionLayer.setDefaultPixelColor(e),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap())}setGridSquareLength(e){0!==e&&void 0!==e&&(this.gridSquareLength=e,this.gridLayer.setGridSquareLength(e),this.interactionLayer.setGridSquareLength(e),this.dataLayer.setGridSquareLength(e),this.dataLayer.updateCapturedImageBitmap(),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null}))}setMinScale(e){if(void 0!==e){if(e>this.maxScale)throw Error("minScale cannot be greater than maxScale");this.minScale=e}}setMaxScale(e){if(void 0!==e){if(e<this.minScale)throw Error("maxScale cannot be less than minScale");this.maxScale=e}}setIsGridVisible(e){this.gridLayer.setIsGridVisible(e),this.renderGridLayer()}setIsPanZoomable(e){void 0!==e&&(this.isPanZoomable=e)}setIsDrawingEnabled(e){void 0!==e&&(this.isDrawingEnabled=e)}setIsInteractionApplicable(e){void 0!==e&&(this.isInteractionApplicable=e)}setBrushTool(e){this.brushTool=e,this.brushTool!==c.SELECT&&(this.interactionLayer.setSelectedArea(null),this.interactionLayer.setSelectingArea(null)),this.emitBrushChangeEvent({brushColor:this.brushColor,brushTool:this.brushTool,brushPattern:this.interactionLayer.getBrushPattern()})}setIsAltPressed(e){this.isAltPressed=e}changeBrushColor(e){this.brushColor=e,this.emitBrushChangeEvent({brushColor:this.brushColor,brushTool:this.brushTool,brushPattern:this.interactionLayer.getBrushPattern()})}setBrushColor(e){if(void 0!==e){this.brushColor=e;let t=this.interactionLayer.getHoveredPixel();t&&(this.interactionLayer.setHoveredPixel(Object.assign(Object.assign({},t),{color:this.brushColor})),this.renderDataLayer())}}getBrushColor(){return this.brushColor}getBrushPattern(){return this.interactionLayer.getBrushPattern()}getColumnCount(){return this.dataLayer.getColumnCount()}getRowCount(){return this.dataLayer.getRowCount()}getGridIndices(){return this.dataLayer.getGridIndices()}getGridSquareLength(){return this.gridSquareLength}getMinScale(){return this.minScale}getMaxScale(){return this.maxScale}detectButtonClicked(e){var t,r,i,a,s,n,o,l;let{top:h,bottom:u,right:c,left:g}=this.gridLayer.getButtonsDimensions(),x=e.x,y=e.y,m=(t=this.panZoom.scale,r=this.maxScale,i=this.minScale,(a=h.height)+(h.height*this.extensionAllowanceRatio-a)*((t-r)/(i-r))),L=(s=this.panZoom.scale,n=this.maxScale,o=this.minScale,(l=g.width)+(g.width*this.extensionAllowanceRatio-l)*((s-n)/(o-n)));if(x>=h.x&&x<=h.x+h.width&&y>=h.y-m+h.height&&y<=h.y+h.height)return d.TOP;if(x>=u.x&&x<=u.x+u.width&&y>=u.y&&y<=u.y+m)return d.BOTTOM;if(x>=g.x-L+g.width&&x<=g.x+g.width&&y>=g.y&&y<=g.y+g.height)return d.LEFT;if(x>=c.x&&x<=c.x+L&&y>=c.y&&y<=c.y+c.height)return d.RIGHT;if(x>=g.x-L+g.width&&x<=g.x+g.width&&y>=h.y-m+h.height&&y<=h.y+h.height)return d.TOPLEFT;if(x>=c.x&&x<=c.x+L&&y>=h.y-m+h.height&&y<=h.y+h.height)return d.TOPRIGHT;if(x>=g.x-L+g.width&&x<=g.x+g.width&&y>=u.y&&y<=u.y+m)return d.BOTTOMLEFT;else if(x>=c.x&&x<=c.x+L&&y>=u.y&&y<=u.y+m)return d.BOTTOMRIGHT;else return null}scale(e,t){this.dataLayer.scale(e,t),this.gridLayer.scale(e,t),this.interactionLayer.scale(e,t),this.foregroundCtx.scale(e,t),this.backgroundCtx.scale(e,t)}setWidth(e,t){this.width=e,this.dataLayer.setWidth(e,t),this.gridLayer.setWidth(e,t),this.interactionLayer.setWidth(e,t),this.foregroundCanvasElement.width=t?e*t:e,this.foregroundCanvasElement.style.width=`${e}px`,this.backgroundCanvasElement.width=t?e*t:e,this.backgroundCanvasElement.style.width=`${e}px`}setHeight(e,t){this.height=e,this.dataLayer.setHeight(e,t),this.gridLayer.setHeight(e,t),this.interactionLayer.setHeight(e,t),this.foregroundCanvasElement.height=t?e*t:e,this.foregroundCanvasElement.style.height=`${e}px`,this.backgroundCanvasElement.height=t?e*t:e,this.backgroundCanvasElement.style.height=`${e}px`}getWidth(){return this.width}getHeight(){return this.height}getCanvasElement(){return this.element}getLayers(){return this.dataLayer.getLayers().map(e=>({id:e.getId(),data:e.getData()}))}getLayersAsArray(){return this.dataLayer.getLayers().map(e=>({id:e.getId(),data:e.getDataArray()}))}getPanZoom(){return this.panZoom}setSize(e,t,r){this.setWidth(e,r),this.setHeight(t,r),this.setDpr(r||this.dpr)}setDpr(e){this.dpr=e,this.dataLayer.setDpr(e),this.gridLayer.setDpr(e),this.interactionLayer.setDpr(e),this.dataLayer.updateCapturedImageBitmap()}setTopLeftIndices(e,t){this.topRowIndex=e,this.leftColumnIndex=t,this.dataLayer.setTopRowIndex(e),this.dataLayer.setLeftColumnIndex(t),this.gridLayer.setTopRowIndex(e),this.gridLayer.setLeftColumnIndex(t),this.interactionLayer.setTopRowIndex(e),this.interactionLayer.setLeftColumnIndex(t)}setCurrentLayer(e){let t=this.dataLayer.getLayer(e);if(!t)throw Error("Layer not found");this.dataLayer.setCurrentLayer(e),this.emitCurrentLayerStatus()}addLayer(e,t,r,i=!1){let a=this.dataLayer.createLayer(e,r);this.dataLayer.getLayers().splice(t,0,a),i&&this.recordAction(new eA(e,a,t)),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap(),this.emitCurrentLayerStatus()}removeLayer(e,t=!1){let r=this.dataLayer.getLayer(e);if(!r)throw Error("Layer not found");if(1===this.dataLayer.getLayers().length)throw Error("Cannot delete last layer");let i=this.dataLayer.getLayerIndex(e);this.dataLayer.getLayers().splice(i,1),this.dataLayer.setCurrentLayer(this.dataLayer.getLayers()[0].getId()),t&&this.recordAction(new eE(r.getId(),r,i)),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap(),this.emitCurrentLayerStatus()}showLayer(e){this.dataLayer.showLayer(e),this.emitCurrentLayerStatus(),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}hideLayer(e){this.dataLayer.hideLayer(e),this.emitCurrentLayerStatus(),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}isolateLayer(e){this.dataLayer.isolateLayer(e),this.emitCurrentLayerStatus(),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}showAllLayers(){this.dataLayer.showAllLayers(),this.emitCurrentLayerStatus(),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}changeLayerPosition(e,t){let r=this.dataLayer.getLayer(e);if(!r)throw Error("Layer not found");let i=this.dataLayer.getLayerIndex(e);this.dataLayer.getLayers().splice(i,1),this.dataLayer.getLayers().splice(t,0,r),this.emitCurrentLayerStatus(),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}reorderLayersByIds(e){this.dataLayer.reorderLayersByIds(e),this.emitCurrentLayerStatus(),this.recordAction(new eT(this.originalLayerIdsInOrderForHistory,e)),this.originalLayerIdsInOrderForHistory=this.dataLayer.getLayers().map(e=>e.getId()),this.renderDataLayer(),this.dataLayer.updateCapturedImageBitmap()}setData(e,t,r=!1){let{isDataValid:i,rowCount:a,columnCount:s}=es(e);if(!i)throw new S;this.undoHistory=[],this.redoHistory=[];let n=e[0][0].columnIndex,o=e[0][0].rowIndex,l=new Map;for(let t=0;t<e.length;t++){l.set(o+t,new Map);for(let r=0;r<e[t].length;r++)l.get(o+t).set(n+r,{color:e[t][r].color})}if(void 0===t){if(this.dataLayer.getLayers().length>1)throw new E;this.dataLayer.setData(l)}else{let e=this.dataLayer.getLayer(t);if(!e)throw new T(t);let r=e.getDataInfo();if(r.rowCount!==a||r.columnCount!==s)throw new w;if(r.gridIndices.leftColumnIndex!==n||r.gridIndices.topRowIndex!==o)throw new A;this.dataLayer.setData(l,t)}this.dataLayer.updateCapturedImageBitmap(),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.gridLayer.setRowCount(a),this.gridLayer.setColumnCount(s),this.interactionLayer.setDataLayerRowCount(a),this.interactionLayer.setDataLayerColumnCount(s),this.setTopLeftIndices(o,n),this.emitDataChangeEvent({isLocalChange:r,data:this.dataLayer.getData(),layerId:this.dataLayer.getCurrentLayer().getId()}),this.emitGridChangeEvent({dimensions:this.dataLayer.getDimensions(),indices:this.dataLayer.getGridIndices()}),this.emitCurrentCanvasInfoStatus(),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.resetCapturedData(),this.adjustInitialZoomScale({width:s,height:a}),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}setLayers(e){ed(e),this.dataLayer.setLayers(e),this.dataLayer.updateCapturedImageBitmap(),this.originalLayerIdsInOrderForHistory=e.map(e=>e.id),this.undoHistory=[],this.redoHistory=[],this.dataLayer.setCurrentLayer(e[0].id),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData());let t=this.dataLayer.getRowCount(),r=this.dataLayer.getColumnCount();this.gridLayer.setRowCount(t),this.gridLayer.setColumnCount(r),this.interactionLayer.setDataLayerRowCount(t),this.interactionLayer.setDataLayerColumnCount(r);let i=this.dataLayer.getTopRowIndex(),a=this.dataLayer.getLeftColumnIndex();this.setTopLeftIndices(i,a),this.emitDataChangeEvent({isLocalChange:!1,data:this.dataLayer.getData(),layerId:this.dataLayer.getCurrentLayer().getId()}),this.emitGridChangeEvent({dimensions:this.dataLayer.getDimensions(),indices:this.dataLayer.getGridIndices()}),this.emitCurrentCanvasInfoStatus(),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.resetCapturedData(),this.adjustInitialZoomScale({width:r,height:t}),this.emitCurrentLayerStatus(),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(this.renderAll)}convertWorldPosToCanvasOffset(e){let t=b(this.element,e,this.dpr),r=M(t,this.panZoom);return r}setPanZoom({offset:e,scale:t,baseColumnCount:r,baseRowCount:i}){let a=r||this.dataLayer.getColumnCount(),s=i||this.dataLayer.getRowCount();if(t&&(this.panZoom.scale=t),e){let t=Object.assign({},e),r=s*this.gridSquareLength*this.panZoom.scale>this.height,i=a*this.gridSquareLength*this.panZoom.scale>this.width,n={x:this.leftColumnIndex*this.gridSquareLength,y:this.topRowIndex*this.gridSquareLength},o=a*this.gridSquareLength,l=s*this.gridSquareLength,d=i?(-n.x-this.width/2-o)*this.panZoom.scale:(-n.x-this.width/2)*this.panZoom.scale,h=r?(-n.y-this.height/2-l)*this.panZoom.scale:(-n.y-this.height/2)*this.panZoom.scale,u=i?this.width-(this.width/2+n.x)*this.panZoom.scale:this.width-(this.width/2+n.x+o)*this.panZoom.scale,c=r?this.height-(this.height/2+n.y)*this.panZoom.scale:this.height-(this.height/2+n.y+l)*this.panZoom.scale;t.x<d&&(t.x=d),t.y<h&&(t.y=h),t.x>u&&(t.x=u),t.y>c&&(t.y=c),this.panZoom.offset=t}this.relayPanZoomToOtherLayers(),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null}),this.emitCurrentCanvasInfoStatus(r,i)}relayPanZoomToOtherLayers(){this.dataLayer.setPanZoom(this.panZoom),this.gridLayer.setPanZoom(this.panZoom),this.interactionLayer.setPanZoom(this.panZoom)}addGridIndices({rowIndices:e,columnIndices:t,data:r,layerId:i,isLocalChange:a=!1}){let{validColumnIndices:s,validRowIndices:n}=this.dataLayer.addGridIndices({rowIndicesToAdd:e,columnIndicesToAdd:t}),o=i||this.dataLayer.getCurrentLayer().getId(),l=r&&r.length>0?this.dataLayer.updatePixelColors(r,o):[],d=n.map(e=>({index:e,isDelete:!1})),h=s.map(e=>({index:e,isDelete:!1}));if(0===s.length&&0===n.length&&0===l.length)return;this.recordSizeChangeAction(n,s,[],[],l.map(e=>Object.assign(Object.assign({},e),{color:e.previousColor,previousColor:e.color}))),this.emitDataChangeEvent({isLocalChange:a,data:this.dataLayer.getData(),layerId:o,delta:{modifiedPixels:l,addedOrDeletedRows:d,addedOrDeletedColumns:h}});let u=this.dataLayer.getData();this.dataLayer.updateCapturedImageBitmap();let c=$(u),g=J(u),x=X(u);(0!==h.length||0!==d.length)&&(this.emitGridChangeEvent({dimensions:{rowCount:g,columnCount:c},indices:x}),this.emitCurrentCanvasInfoStatus()),this.relayDataDimensionsToLayers(),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.resetCapturedData(),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}deleteGridIndices({rowIndices:e,columnIndices:t,layerId:r,isLocalChange:i=!1}){let{validColumnIndices:a,validRowIndices:s,swipedPixels:n}=this.dataLayer.deleteGridIndices({rowIndicesToDelete:e,columnIndicesToDelete:t}),o=r||this.dataLayer.getCurrentLayer().getId(),l=s.map(e=>({index:e,isDelete:!0})),d=a.map(e=>({index:e,isDelete:!0}));if(0===a.length&&0===s.length&&0===n.length)return;this.recordSizeChangeAction([],[],s,a,n),this.emitDataChangeEvent({isLocalChange:i,data:this.dataLayer.getData(),layerId:o,delta:{modifiedPixels:[],addedOrDeletedRows:l,addedOrDeletedColumns:d}});let h=this.dataLayer.getData();this.dataLayer.updateCapturedImageBitmap();let u=$(h),c=J(h),g=X(h);(0!==d.length||0!==l.length)&&(this.emitGridChangeEvent({dimensions:{rowCount:c,columnCount:u},indices:g}),this.emitCurrentCanvasInfoStatus()),this.relayDataDimensionsToLayers(),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.resetCapturedData(),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}extendInteractionGridBy(e,t){let r=this.interactionLayer,i=r.getCapturedData();if(!i||t.x<=0&&t.y<=0)return;for(let[i,a]of Object.entries(t))for(let t=0;t<a;t++)(e===d.TOPLEFT||e===d.TOPRIGHT)&&"y"===i?r.extendCapturedData(d.TOP):(e===d.BOTTOMLEFT||e===d.BOTTOMRIGHT)&&"y"===i?r.extendCapturedData(d.BOTTOM):(e===d.TOPLEFT||e===d.BOTTOMLEFT)&&"x"===i?r.extendCapturedData(d.LEFT):(e===d.TOPRIGHT||e===d.BOTTOMRIGHT)&&"x"===i?r.extendCapturedData(d.RIGHT):r.extendCapturedData(e);let a=X(i);this.interactionLayer.setTopRowIndex(a.topRowIndex),this.interactionLayer.setLeftColumnIndex(a.leftColumnIndex),this.gridLayer.setTopRowIndex(a.topRowIndex),this.gridLayer.setLeftColumnIndex(a.leftColumnIndex)}shortenInteractionGridBy(e,t){let r=this.interactionLayer;if(t.x<=0&&t.y<=0)return;for(let[i,a]of Object.entries(t))for(let t=0;t<a;t++)(e===d.TOPLEFT||e===d.TOPRIGHT)&&"y"===i?r.shortenCapturedData(d.TOP):(e===d.BOTTOMLEFT||e===d.BOTTOMRIGHT)&&"y"===i?r.shortenCapturedData(d.BOTTOM):(e===d.TOPLEFT||e===d.BOTTOMLEFT)&&"x"===i?r.shortenCapturedData(d.LEFT):(e===d.TOPRIGHT||e===d.BOTTOMRIGHT)&&"x"===i?r.shortenCapturedData(d.RIGHT):r.shortenCapturedData(e);let i=X(r.getCapturedData());this.interactionLayer.setTopRowIndex(i.topRowIndex),this.interactionLayer.setLeftColumnIndex(i.leftColumnIndex),this.gridLayer.setLeftColumnIndex(i.leftColumnIndex),this.gridLayer.setTopRowIndex(i.topRowIndex)}drawPixelInInteractionLayer(e,t,r){var i,a,s,n,o,l;let d=this.interactionLayer,h=this.dataLayer.getData(),u=r.length,g=r[0].length,x=Math.floor(g/2),y=Math.floor(u/2);if(this.brushTool===c.ERASER)for(let s=0;s<r.length;s++)for(let n=0;n<r[s].length;n++){let o=r[s][n];if(0===o)continue;let l=null===(a=null===(i=h.get(e+s-x))||void 0===i?void 0:i.get(t+n-y))||void 0===a?void 0:a.color;d.addToErasedPixelRecords(f,{rowIndex:e+s-x,columnIndex:t+n-y,color:"",previousColor:l})}else if(this.brushTool===c.DOT)for(let i=0;i<r.length;i++)for(let a=0;a<r[i].length;a++){let o=r[i][a];if(0===o)continue;let{topRowIndex:l,leftColumnIndex:u,bottomRowIndex:c,rightColumnIndex:g}=X(h),m=e+i-x,L=t+a-y;if(m<l||m>c||L<u||L>g)continue;let I=null===(n=null===(s=h.get(m))||void 0===s?void 0:s.get(L))||void 0===n?void 0:n.color;d.addToStrokePixelRecords(f,{rowIndex:m,columnIndex:L,color:this.brushColor,previousColor:I})}else if(this.brushTool===c.PAINT_BUCKET){let r=X(h),i=null===(l=null===(o=h.get(e))||void 0===o?void 0:o.get(t))||void 0===l?void 0:l.color;if(i===this.brushColor)return;this.colorPixelsArea(i,r,{rowIndex:e,columnIndex:t})}this.renderInteractionLayer()}relayDataDimensionsToLayers(){let e=$(this.dataLayer.getData());this.gridLayer.setColumnCount(e),this.interactionLayer.setDataLayerColumnCount(e);let t=J(this.dataLayer.getData());this.gridLayer.setRowCount(t),this.interactionLayer.setDataLayerRowCount(t)}relayInteractionDataToDataLayer(){let e=this.interactionLayer,t=!1;if(this.isInteractionApplicable){let r=e.getEffectiveStrokePixelChanges(f),i=e.getEffectiveEraserPixelChanges(f),a=[...r,...i],s=[],n=[],o=[];if(0!==a.length){let{totalAddedColumnIndices:e,totalAddedRowIndices:t}=this.dataLayer.colorPixels(a,this.dataLayer.getCurrentLayer().getId());this.recordColorChangeAction(a),s.push(...a),o.push(...e.map(e=>({index:e,isDelete:!1}))),n.push(...t.map(e=>({index:e,isDelete:!1}))),this.emitStrokeEndEvent({strokedPixels:a,strokeTool:this.brushTool})}let l=e.getCapturedData();if(l){let e=X(l),t=this.interactionLayer.getCapturedDataOriginalIndices(),r=e.topRowIndex-t.topRowIndex,i=e.leftColumnIndex-t.leftColumnIndex,a=e.bottomRowIndex-t.bottomRowIndex,s=e.rightColumnIndex-t.rightColumnIndex;if(r<0){let e=Array.from(Array(-r),(e,r)=>t.topRowIndex-r-1);n.push(...e.map(e=>({index:e,isDelete:!1})))}else if(r>0){let e=Array.from(Array(r),(e,r)=>t.topRowIndex+r);n.push(...e.map(e=>({index:e,isDelete:!0})))}if(i<0){let e=Array.from(Array(-i),(e,r)=>t.leftColumnIndex-r-1);o.push(...e.map(e=>({index:e,isDelete:!1})))}else if(i>0){let e=Array.from(Array(i),(e,r)=>t.leftColumnIndex+r);o.push(...e.map(e=>({index:e,isDelete:!0})))}if(a>0){let e=Array.from(Array(a),(e,r)=>t.bottomRowIndex+r+1);n.push(...e.map(e=>({index:e,isDelete:!1})))}else if(a<0){let e=Array.from(Array(-a),(e,r)=>t.bottomRowIndex-r);n.push(...e.map(e=>({index:e,isDelete:!0})))}if(s>0){let e=Array.from(Array(s),(e,r)=>t.rightColumnIndex+r+1);o.push(...e.map(e=>({index:e,isDelete:!1})))}else if(s<0){let e=Array.from(Array(-s),(e,r)=>t.rightColumnIndex-r);o.push(...e.map(e=>({index:e,isDelete:!0})))}if(0!==o.length||0!==n.length){let e=o.filter(e=>!1===e.isDelete).map(e=>e.index),t=n.filter(e=>!1===e.isDelete).map(e=>e.index),r=o.filter(e=>!0===e.isDelete).map(e=>e.index),i=n.filter(e=>!0===e.isDelete).map(e=>e.index);this.dataLayer.addGridIndices({rowIndicesToAdd:t,columnIndicesToAdd:e});let a=this.dataLayer.deleteGridIndices({rowIndicesToDelete:i,columnIndicesToDelete:r}).swipedPixels;this.recordSizeChangeAction(t,e,i,r,a)}}let d=this.dataLayer.getData();(0!==s.length||0!==n.length||0!==o.length)&&(t=!0,this.emitDataChangeEvent({isLocalChange:!0,data:d,layerId:this.dataLayer.getCurrentLayer().getId(),delta:{modifiedPixels:s,addedOrDeletedRows:n,addedOrDeletedColumns:o}}));let h=$(d),u=J(d),c=X(d);(0!==o.length||0!==n.length)&&(this.setTopLeftIndices(c.topRowIndex,c.leftColumnIndex),this.emitGridChangeEvent({dimensions:{rowCount:u,columnCount:h},indices:c}),this.emitCurrentCanvasInfoStatus()),e.deleteErasedPixelRecord(f),e.deleteStrokePixelRecord(f),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData())}return this.relayDataDimensionsToLayers(),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),e.resetCapturedData(),t}recordSizeChangeAction(e,t,r,i,a){this.recordAction(new ew(a,e,t,r,i,this.dataLayer.getCurrentLayer().getId()))}recordColorChangeAction(e){this.recordAction(new eS(e,this.dataLayer.getCurrentLayer().getId()))}commitAction(e){let t=e.getType(),r=e.getLayerId();t!==x.SelectAreaMove&&(this.interactionLayer.setSelectedArea(null),this.setBrushTool(c.DOT));let i=[],a=[],s=[];switch(t){case x.ColorChange:this.dataLayer.updatePixelColors(e.data,r),i.push(...e.data);break;case x.ColorSizeChange:let n=Array.from(e.rowIndicesToAdd),o=Array.from(e.rowIndicesToDelete),l=Array.from(e.columnIndicesToAdd),d=Array.from(e.columnIndicesToDelete);this.dataLayer.deleteGridIndices({rowIndicesToDelete:o,columnIndicesToDelete:d}),this.dataLayer.addGridIndices({rowIndicesToAdd:n,columnIndicesToAdd:l}),a.push(...d.map(e=>({index:e,isDelete:!0})),...l.map(e=>({index:e,isDelete:!1}))),s.push(...o.map(e=>({index:e,isDelete:!0})),...n.map(e=>({index:e,isDelete:!1})));let h=e.data;i.push(...h),this.dataLayer.updatePixelColors(h,r);break;case x.SelectAreaMove:let u=this.dataLayer.updatePixelColors(e.data,r);i.push(...u),this.brushTool=c.SELECT,this.interactionLayer.setSelectedArea(e.newSelectedArea);break;case x.LayerCreate:this.addLayer(e.layerId,e.removeIndex,e.layer.getDataArray());break;case x.LayerDelete:this.removeLayer(e.layerId),this.dataLayer.getCurrentLayer().getId()===e.layerId&&this.dataLayer.setCurrentLayer(this.dataLayer.getLayers()[0].getId());break;case x.LayerOrderChange:this.dataLayer.reorderLayersByIds(e.reorderdLayerIds)}if(this.emitCurrentLayerStatus(),!this.dataLayer.getLayer(r))return;let g=this.dataLayer.getLayer(r).getData(),y=U(g)[0],m=Y(g)[0];this.setTopLeftIndices(m,y),this.dataLayer.updateCapturedImageBitmap(),this.emitGridChangeEvent({dimensions:{rowCount:J(g),columnCount:$(g)},indices:X(g)}),this.emitDataChangeEvent({isLocalChange:!0,data:g,layerId:r,delta:{modifiedPixels:i,addedOrDeletedRows:s,addedOrDeletedColumns:a}})}recordAction(e){this.undoHistory.length>=this.maxHistoryCount&&this.undoHistory.shift(),this.undoHistory.push(e),this.redoHistory=[]}undo(){if(0===this.undoHistory.length)return;let e=this.undoHistory.pop(),t=e.createInverseAction();this.commitAction(t),this.redoHistory.push(e);let r=J(this.dataLayer.getData()),i=$(this.dataLayer.getData());this.gridLayer.setRowCount(r),this.gridLayer.setColumnCount(i),this.interactionLayer.setDataLayerRowCount(r),this.interactionLayer.setDataLayerColumnCount(i),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}redo(){if(0===this.redoHistory.length)return;let e=this.redoHistory.pop();this.commitAction(e),this.undoHistory.push(e);let t=J(this.dataLayer.getData()),r=$(this.dataLayer.getData());this.gridLayer.setRowCount(t),this.gridLayer.setColumnCount(r),this.interactionLayer.setDataLayerRowCount(t),this.interactionLayer.setDataLayerColumnCount(r),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}erasePixels(e,t,r=!1){let{dataForAction:i}=this.dataLayer.erasePixels(e,t),a=t||this.dataLayer.getCurrentLayer().getId();null!==this.interactionLayer.getCapturedData()&&this.interactionLayer.erasePixels(e),this.dataLayer.updateCapturedImageBitmap(),this.recordAction(new eS(i,a)),this.emitDataChangeEvent({isLocalChange:r,data:this.dataLayer.getLayer(a).getData(),layerId:a,delta:{modifiedPixels:i,addedOrDeletedColumns:[],addedOrDeletedRows:[]}}),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}colorPixels(e,t,r=!1){let{dataForAction:i,totalAddedColumnIndices:a,totalAddedRowIndices:s}=this.dataLayer.colorPixels(e,t),n=t||this.dataLayer.getCurrentLayer().getId();null!==this.interactionLayer.getCapturedData()?(this.interactionLayer.colorPixels(e),this.interactionLayer.setCriterionDataForRendering(this.interactionLayer.getCapturedData())):this.interactionLayer.setCriterionDataForRendering(this.dataLayer.getLayer(n).getData()),this.dataLayer.updateCapturedImageBitmap(),this.relayDataDimensionsToLayers(),this.recordAction(new ew(i.map(e=>({rowIndex:e.rowIndex,columnIndex:e.columnIndex,color:e.previousColor})),s,a,[],[],n)),this.emitDataChangeEvent({isLocalChange:r,data:this.dataLayer.getLayer(n).getData(),layerId:n,delta:{modifiedPixels:i,addedOrDeletedColumns:a.map(e=>({index:e,isDelete:!1})),addedOrDeletedRows:s.map(e=>({index:e,isDelete:!1}))}}),this.gridLayer.setCriterionDataForRendering(this.dataLayer.getLayer(n).getData()),this.dataLayer.setCriterionDataForRendering(this.dataLayer.getLayer(n).getData()),this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}colorPixelsArea(e,t,r){var i;let a=this.interactionLayer,s=new eR;s.enqueue(r),a.setCapturedData(this.dataLayer.getCopiedData());let n=this.interactionLayer.getCapturedData();for(;s.size()>0;){let{rowIndex:r,columnIndex:o}=s.dequeue();if(!function(e,t,r){let{topRowIndex:i,bottomRowIndex:a,leftColumnIndex:s,rightColumnIndex:n}=r;return!(e<i||e>a||t<s||t>n)}(r,o,t))continue;let l=null===(i=n.get(r))||void 0===i?void 0:i.get(o);if(!l||(null==l?void 0:l.color)!==e)continue;let d=this.brushColor,h=n.get(r).get(o).color;n.get(r).get(o).color=d,a.addToStrokePixelRecords(f,{rowIndex:r,columnIndex:o,color:d,previousColor:h}),[{rowIndex:r-1,columnIndex:o},{rowIndex:r+1,columnIndex:o},{rowIndex:r,columnIndex:o-1},{rowIndex:r,columnIndex:o+1}].forEach(({rowIndex:e,columnIndex:t})=>{s.enqueue({rowIndex:e,columnIndex:t})})}}onMouseDown(e){e.preventDefault();let t=k(e,this.element,this.panZoom);this.panPoint.lastMousePos={x:t.offsetX,y:t.offsetY};let r=H(e,this.element,this.panZoom,this.dpr);this.mouseDownWorldPos={x:r.x,y:r.y},this.mouseDownPanZoom={offset:{x:this.panZoom.offset.x,y:this.panZoom.offset.y},scale:this.panZoom.scale};let i=Array.from(this.dataLayer.getRowKeyOrderMap().keys()),a=Array.from(this.dataLayer.getColumnKeyOrderMap().keys()),s=Z(r,i,a,this.gridSquareLength);this.mouseMode=s?h.DRAWING:h.PANNING;let n=this.detectButtonClicked(r);if(n&&(this.mouseMode=h.EXTENDING),this.brushTool===c.SELECT&&(this.mouseMode=h.DRAWING),this.mouseMode===h.DRAWING){if(this.brushTool===c.SELECT){let e=this.interactionLayer.getSelectedArea(),t=!1;if(e){let r=this.interactionLayer.detectSelectedAreaExtendDirection(this.mouseDownWorldPos);if(this.interactionLayer.setDirectionToExtendSelectedArea(r),t=q(this.mouseDownWorldPos,e),null!==r){let t=this.getColoredPixelsInSelectedArea(e,"");this.interactionLayer.setExtendingSelectedArea(e),this.interactionLayer.setExtendingSelectedPixels(t),this.interactionLayer.setCapturedBaseExtendingSelectedArea(e),this.interactionLayer.setCapturedBaseExtendingSelectedAreaPixels(t),this.dataLayer.erasePixels(t),this.dataLayer.render(),this.interactionLayer.render();return}}if(t){this.interactionLayer.setSelectingArea(null);let t=this.getColoredPixelsInSelectedArea(e,"");this.dataLayer.erasePixels(t),this.interactionLayer.setSelectedAreaPixels(t),this.interactionLayer.setMovingSelectedPixels(t),this.interactionLayer.setMovingSelectedArea(e),this.dataLayer.render(),this.interactionLayer.render()}else this.interactionLayer.setSelectedArea(null),this.interactionLayer.setSelectingArea({startWorldPos:this.mouseDownWorldPos,endWorldPos:this.mouseDownWorldPos})}else this.brushTool===c.DOT&&s&&(this.drawPixelInInteractionLayer(s.rowIndex,s.columnIndex,this.interactionLayer.getBrushPattern()),this.renderInteractionLayer())}else if(this.mouseMode===h.PANNING){let t=e.touches&&e.touches.length?e.touches.length:0;if(2===t){this.mouseMode=h.PINCHZOOMING;let t=F(e,this.element,this.panZoom,this.dpr);t?(this.mouseDownWorldPos={x:t.x,y:t.y},this.panPoint.lastMousePos={x:t.x,y:t.y}):this.mouseMode=h.NULL}else t>2&&(this.mouseMode=h.NULL)}else if(this.mouseMode===h.EXTENDING){let e=this.gridLayer.getIsGridFixed();!e&&n&&(this.extensionPoint.direction=n,this.mouseMode=h.EXTENDING)}this.previousMouseMoveWorldPos=this.mouseDownWorldPos}getColoredPixelsInSelectedArea(e,t){var r,i;let a=this.dataLayer.getData(),s=this.dataLayer.getRowCount(),n=this.dataLayer.getColumnCount(),o=Y(a),l=U(a),d=o.sort((e,t)=>e-t),h=l.sort((e,t)=>e-t),u=null===(r=_(e,s,n,this.gridSquareLength,d,h))||void 0===r?void 0:r.includedPixelsIndices;if(!u)return[];let{topRowIndex:c,bottomRowIndex:g,leftColumnIndex:x,rightColumnIndex:y}=X(a),m=[];for(let e of u){let r=e.rowIndex,s=e.columnIndex,n=null===(i=a.get(r).get(s))||void 0===i?void 0:i.color;n&&m.push({rowIndex:r,columnIndex:s,previousColor:n,color:t})}let L=m.filter(({rowIndex:e,columnIndex:t})=>e>=c&&e<=g&&t>=x&&t<=y);return L}onMouseMove(e){e.preventDefault();let t=H(e,this.element,this.panZoom,this.dpr);if(this.mouseMoveWorldPos={x:t.x,y:t.y},this.styleMouseCursor(t),this.mouseMode===h.NULL){if(this.brushTool===c.SELECT){let e=this.interactionLayer.getSelectedArea();e&&(this.gridLayer.render(),this.gridLayer.renderSelection(e));return}let e=Array.from(this.dataLayer.getRowKeyOrderMap().keys()),r=Array.from(this.dataLayer.getColumnKeyOrderMap().keys()),i=this.interactionLayer.getHoveredPixel(),a=Z(t,e,r,this.gridSquareLength);a?i&&i.rowIndex===a.rowIndex&&i.columnIndex===a.columnIndex||(this.interactionLayer.setHoveredPixel({rowIndex:a.rowIndex,columnIndex:a.columnIndex,color:this.brushTool!==c.ERASER?this.brushColor:"white"}),this.emitHoverPixelChangeEvent({indices:a}),this.renderInteractionLayer()):(this.emitHoverPixelChangeEvent({indices:null}),this.interactionLayer.setHoveredPixel(null),this.renderInteractionLayer());let s=this.detectButtonClicked(t);this.gridLayer.setHoveredButton(s),this.renderGridLayer()}else if(this.mouseMode===h.EXTENDING){if(this.gridLayer.getIsGridFixed())return;let t=this.extensionPoint.direction;this.interactionLayer.getCapturedData()||(this.gridLayer.setHoveredButton(t),this.renderGridLayer()),this.handleExtension(e)}else if(this.mouseMode===h.PANNING){if(!this.isPanZoomable)return;this.handlePanning(e)}else if(this.mouseMode===h.PINCHZOOMING)this.handlePinchZoom(e);else if(this.mouseMode==h.DRAWING){let e=Array.from(this.dataLayer.getRowKeyOrderMap().keys()),r=Array.from(this.dataLayer.getColumnKeyOrderMap().keys()),i=Z(t,e,r,this.gridSquareLength);if(this.brushTool===c.SELECT){let e=this.interactionLayer.getSelectingArea(),t=this.interactionLayer.getSelectedArea(),r=this.interactionLayer.getSelectedAreaPixels(),i=this.interactionLayer.getMovingSelectedPixels(),a=this.interactionLayer.getDirectionToExtendSelectedArea();if(null!==a&&(this.interactionLayer.extendSelectedArea(a,this.mouseMoveWorldPos,this.isAltPressed),this.gridLayer.render(),this.gridLayer.renderSelection(this.interactionLayer.getExtendingSelectedArea()),this.interactionLayer.render()),i&&this.mouseDownWorldPos&&t){let e=R(this.mouseDownWorldPos,this.mouseMoveWorldPos),i=Math.round(e.x/this.gridSquareLength),a=Math.round(e.y/this.gridSquareLength),s=r.map(e=>Object.assign(Object.assign({},e),{rowIndex:e.rowIndex-a,columnIndex:e.columnIndex-i}));this.interactionLayer.setMovingSelectedArea({startWorldPos:{x:t.startWorldPos.x-i*this.gridSquareLength,y:t.startWorldPos.y-a*this.gridSquareLength},endWorldPos:{x:t.endWorldPos.x-i*this.gridSquareLength,y:t.endWorldPos.y-a*this.gridSquareLength},startPixelIndex:{rowIndex:t.startPixelIndex.rowIndex-a,columnIndex:t.startPixelIndex.columnIndex-i},endPixelIndex:{rowIndex:t.endPixelIndex.rowIndex-a,columnIndex:t.endPixelIndex.columnIndex-i}}),this.interactionLayer.setMovingSelectedPixels(s);let n=this.interactionLayer.getMovingSelectedArea();this.gridLayer.render(),this.gridLayer.renderSelection(n),this.interactionLayer.render();return}if(null!==e){this.interactionLayer.setSelectingArea({startWorldPos:this.mouseDownWorldPos,endWorldPos:this.mouseMoveWorldPos});let e=this.interactionLayer.getSelectingArea();this.renderGridLayer(),this.gridLayer.renderSelection(e);return}}else if(i){this.drawPixelInInteractionLayer(i.rowIndex,i.columnIndex,this.interactionLayer.getBrushPattern());let e=el(this.previousMouseMoveWorldPos,this.mouseMoveWorldPos,this.gridSquareLength,this.dataLayer.getData());(null==e?void 0:e.length)&&e.forEach(e=>{this.drawPixelInInteractionLayer(e.rowIndex,e.columnIndex,this.interactionLayer.getBrushPattern())}),this.renderInteractionLayer(),this.brushTool===c.ERASER&&this.renderErasedPixelsFromInteractionLayerInDataLayer()}}this.previousMouseMoveWorldPos=this.mouseMoveWorldPos}getSelectedArea(){return this.interactionLayer.getSelectedArea()}onKeyDown(e){if("KeyZ"===e.code&&(e.ctrlKey||e.metaKey))this.undo();else if("KeyY"===e.code&&(e.ctrlKey||e.metaKey))this.redo();else if("Backspace"===e.code||"Delete"===e.code){if(this.interactionLayer.getSelectedArea()){if(0===this.interactionLayer.getSelectedAreaPixels().length)return;let e=this.interactionLayer.getSelectedAreaPixels();if(!e||0===e.length)return;let{dataForAction:t}=this.dataLayer.erasePixels(this.interactionLayer.getSelectedAreaPixels());this.recordAction(new ev([...t.map(e=>Object.assign(Object.assign({},e),{color:""})),...t],this.interactionLayer.getSelectedArea(),this.interactionLayer.getSelectedArea(),this.dataLayer.getCurrentLayer().getId())),this.dataLayer.render()}}else if("Escape"===e.code)this.interactionLayer.setExtendingSelectedArea(null),this.interactionLayer.setExtendingSelectedPixels([]),this.interactionLayer.setMovingSelectedArea(null),this.interactionLayer.setMovingSelectedPixels([]),this.interactionLayer.setSelectingArea(null),this.interactionLayer.setSelectedArea(null),this.interactionLayer.setSelectedAreaPixels([]),this.gridLayer.render();else if("AltLeft"===e.code){let e=this.interactionLayer.getExtendingSelectedPixels(),t=this.interactionLayer.getExtendingSelectedArea();e&&t&&(this.interactionLayer.setCapturedBaseExtendingSelectedArea(t),this.interactionLayer.setCapturedBaseExtendingSelectedAreaPixels(e)),this.isAltPressed=!0}}onKeyUp(e){if("AltLeft"===e.code){let e=this.interactionLayer.getExtendingSelectedPixels(),t=this.interactionLayer.getExtendingSelectedArea();e&&t&&(this.interactionLayer.setCapturedBaseExtendingSelectedArea(t),this.interactionLayer.setCapturedBaseExtendingSelectedAreaPixels(e)),this.isAltPressed=!1}}relaySelectingAreaToSelectedArea(){var e;let t=this.interactionLayer.getSelectingArea();if(t){let r=this.dataLayer.getData(),i=this.dataLayer.getRowCount(),a=this.dataLayer.getColumnCount(),s=Y(r),n=U(r),o=s.sort((e,t)=>e-t),l=n.sort((e,t)=>e-t),d=_(t,i,a,this.gridSquareLength,o,l);if(d){this.interactionLayer.setSelectedArea({startWorldPos:d.startWorldPos,endWorldPos:d.endWorldPos,startPixelIndex:d.includedPixelsIndices[0],endPixelIndex:d.includedPixelsIndices[d.includedPixelsIndices.length-1]});let t=this.dataLayer.getData(),r=[];for(let i of d.includedPixelsIndices){let a=i.rowIndex,s=i.columnIndex,n=null===(e=t.get(a).get(s))||void 0===e?void 0:e.color;n&&r.push({rowIndex:a,columnIndex:s,previousColor:n,color:""})}this.interactionLayer.setSelectedAreaPixels(r),this.gridLayer.renderSelection({startWorldPos:d.startWorldPos,endWorldPos:d.endWorldPos})}}this.interactionLayer.setSelectingArea(null)}relayExtendingSelectedAreaToSelectedArea(){let e=this.interactionLayer.getSelectedArea(),t=this.interactionLayer.getSelectedAreaPixels(),r=this.interactionLayer.getExtendingSelectedArea(),i=this.interactionLayer.getExtendingSelectedPixels();if(!e||!t||!r||!i)return;let a=this.dataLayer.getData(),{topRowIndex:s,bottomRowIndex:n,leftColumnIndex:o,rightColumnIndex:l}=X(a),d=i.filter(e=>e.rowIndex<=n&&e.columnIndex<=l&&e.rowIndex>=s&&e.columnIndex>=o).map(e=>{var t;let r=null===(t=a.get(e.rowIndex).get(e.columnIndex))||void 0===t?void 0:t.color;return Object.assign(Object.assign({},e),{color:e.previousColor,previousColor:r})}),{dataForAction:h}=this.dataLayer.colorPixels(d,this.dataLayer.getCurrentLayer().getId());this.recordAction(new ev([...h,...t],e,r,this.dataLayer.getCurrentLayer().getId()));let u=new Map;for(let e of t)u.set(eI(e.rowIndex,e.columnIndex),e);for(let e of h)u.set(eI(e.rowIndex,e.columnIndex),e);let g=Array.from(u.values()),x=this.dataLayer.getData();g.length>0&&(this.emitStrokeEndEvent({strokedPixels:g,strokeTool:c.SELECT}),this.emitDataChangeEvent({isLocalChange:!0,data:x,layerId:this.dataLayer.getCurrentLayer().getId(),delta:{modifiedPixels:g,addedOrDeletedColumns:[],addedOrDeletedRows:[]}})),this.interactionLayer.setSelectedArea(r),this.interactionLayer.setSelectedAreaPixels(d),this.interactionLayer.setExtendingSelectedArea(null),this.interactionLayer.setExtendingSelectedPixels(null),this.interactionLayer.setDirectionToExtendSelectedArea(null),this.gridLayer.render(),this.gridLayer.renderSelection(r),this.interactionLayer.setSelectedAreaPixels(d)}relayMovingSelectedAreaToSelectedArea(){let e=this.interactionLayer.getSelectedArea(),t=this.interactionLayer.getSelectedAreaPixels(),r=this.interactionLayer.getMovingSelectedArea(),i=this.interactionLayer.getMovingSelectedPixels();if(!e||!t||!r||!i)return;let a=this.dataLayer.getData(),{topRowIndex:s,bottomRowIndex:n,leftColumnIndex:o,rightColumnIndex:l}=X(a),d=i.filter(e=>e.rowIndex<=n&&e.columnIndex<=l&&e.rowIndex>=s&&e.columnIndex>=o).map(e=>{var t;return Object.assign(Object.assign({},e),{color:e.previousColor,previousColor:(null===(t=a.get(e.rowIndex).get(e.columnIndex))||void 0===t?void 0:t.color)||""})}),{dataForAction:h}=this.dataLayer.colorPixels(d,this.dataLayer.getCurrentLayer().getId());this.recordAction(new ev([...h,...t],e,r,this.dataLayer.getCurrentLayer().getId()));let u=new Map;for(let e of t)u.set(eI(e.rowIndex,e.columnIndex),e);for(let e of h)u.set(eI(e.rowIndex,e.columnIndex),e);let g=Array.from(u.values()),x=this.dataLayer.getCopiedData();g.length>0&&(this.emitStrokeEndEvent({strokedPixels:g,strokeTool:c.SELECT}),this.emitDataChangeEvent({isLocalChange:!0,data:x,layerId:this.dataLayer.getCurrentLayer().getId(),delta:{modifiedPixels:g,addedOrDeletedColumns:[],addedOrDeletedRows:[]}}));let y=this.interactionLayer.getMovingSelectedArea();if(y){this.interactionLayer.setSelectedArea(y);let e=this.interactionLayer.getMovingSelectedPixels();this.interactionLayer.setSelectedAreaPixels(e)}this.interactionLayer.setMovingSelectedArea(null),this.interactionLayer.setMovingSelectedPixels(null),this.gridLayer.render(),this.gridLayer.renderSelection(y)}onInteractionEnded(e){e.preventDefault();let t=this.relayInteractionDataToDataLayer();this.mouseMode!==h.NULL&&t&&(this.dataLayer.render(),this.dataLayer.updateCapturedImageBitmap()),this.mouseMode=h.NULL,this.interactionLayer.setSelectingArea(null),null!==this.gridLayer.getHoveredButton()&&this.emitHoverPixelChangeEvent({indices:null}),this.pinchZoomDiff=void 0,this.gridLayer.setHoveredButton(null),this.renderGridLayer();let r=this.interactionLayer.getSelectedArea();r&&this.gridLayer.renderSelection(r),this.mouseDownWorldPos=null,this.mouseDownPanZoom=null,this.previousMouseMoveWorldPos=null,this.lastRenderAllCall&&cancelAnimationFrame(this.lastRenderAllCall),this.lastRenderAllCall=requestAnimationFrame(()=>{this.renderAll(),this.lastRenderAllCall=null})}onMouseUp(e){if(this.brushTool===c.SELECT){this.relaySelectingAreaToSelectedArea(),this.relayMovingSelectedAreaToSelectedArea(),this.relayExtendingSelectedAreaToSelectedArea();let e=this.interactionLayer.getSelectedArea(),t=N(e,this.dataLayer.getRowCount(),this.dataLayer.getColumnCount(),this.gridSquareLength);t||(this.interactionLayer.setMovingSelectedArea(null),this.interactionLayer.setMovingSelectedPixels(null),this.interactionLayer.setSelectedArea(null),this.interactionLayer.setSelectedAreaPixels(null),this.gridLayer.render())}this.onInteractionEnded(e)}onMouseOut(e){this.onInteractionEnded(e)}renderGridLayer(){this.gridLayer.render()}clear(){let e=this.dataLayer.clear();this.undoHistory=[],this.redoHistory=[];for(let t=0;t<e.length;t++){let{layerId:r,data:i}=e[t];this.emitDataChangeEvent({isLocalChange:!0,layerId:r,data:this.dataLayer.getLayer(r).getData(),delta:{addedOrDeletedColumns:[],addedOrDeletedRows:[],modifiedPixels:i}})}this.dataLayer.updateCapturedImageBitmap(),this.renderDataLayer()}downloadImage(e){var t,r;let i=this.dataLayer.getData(),a=this.getColumnCount(),s=this.getRowCount(),n=Y(i),o=U(i),l=en(i),d=eo(i);if(X(i),"png"===e.type){let t=document.createElement("canvas");t.width=a*this.gridSquareLength,t.height=s*this.gridSquareLength;let r=t.getContext("2d");for(let t of n){for(let e of o){let a=l.get(t),s=d.get(e),n=i.get(t).get(e);if(n&&n.color){let e={x:s*this.gridSquareLength,y:a*this.gridSquareLength};r.save(),r.fillStyle=n.color,r.fillRect(e.x,e.y,this.gridSquareLength,this.gridSquareLength),r.restore()}}if(r.save(),r.strokeStyle="#000000",r.lineWidth=1,e&&e.isGridVisible){for(let e=0;e<=this.getColumnCount();e++)r.beginPath(),r.moveTo(e*this.gridSquareLength,0),r.lineTo(e*this.gridSquareLength,s*this.gridSquareLength),r.stroke(),r.closePath();for(let e=0;e<=this.getRowCount();e++)r.beginPath(),r.moveTo(0,e*this.gridSquareLength),r.lineTo(a*this.gridSquareLength,e*this.gridSquareLength),r.stroke(),r.closePath()}r.restore()}let h=document.createElement("a");h.href=t.toDataURL("image/png"),h.download="dotting.png",h.click()}else if("svg"===e.type){let e=document.createElementNS("http://www.w3.org/2000/svg","svg"),h=s-1,u=0,c=a-1,g=0,x=[];for(let e=0;e<n.length;e++){let a=n[e];for(let s=0;s<o.length;s++){let n=o[s],l=null===(r=null===(t=i.get(a))||void 0===t?void 0:t.get(n))||void 0===r?void 0:r.color;l&&(h=Math.min(h,a),u=Math.max(u,a),c=Math.min(c,n),g=Math.max(g,n),x.push({rowIndex:e,columnIndex:s,color:l}))}}let y=l.get(h),m=d.get(c),L=(g-c+1)*this.gridSquareLength,f=(u-h+1)*this.gridSquareLength;if(e.setAttribute("width",`${L}`),e.setAttribute("height",`${f}`),0===x.length)throw new D;for(let t=0;t<x.length;t++){let{rowIndex:r,columnIndex:i,color:a}=x[t],s=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=r-y,o=i-m;s.setAttribute("y",`${n*this.gridSquareLength}`),s.setAttribute("x",`${o*this.gridSquareLength}`),s.setAttribute("width",`${this.gridSquareLength}`),s.setAttribute("height",`${this.gridSquareLength}`),s.setAttribute("fill",`${a}`),e.appendChild(s)}let I=new XMLSerializer().serializeToString(e),p=document.createElement("a");p.href=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(I)}`,p.download="dotting.svg",p.click()}else throw new v}renderAll(){let e=this.interactionLayer.getCapturedData();if(e){let t=J(e),r=$(e);this.gridLayer.setRowCount(t),this.gridLayer.setColumnCount(r)}else(this.mouseMode===h.PANNING||this.mouseMode===h.PINCHZOOMING||this.mouseMode===h.NULL)&&this.dataLayer.getCapturedImageBitmap()?this.dataLayer.renderImageBitmap():this.renderDataLayer(),this.renderErasedPixelsFromInteractionLayerInDataLayer();this.renderInteractionLayer(),this.renderGridLayer();let t=this.interactionLayer.getSelectedArea();t&&this.gridLayer.renderSelection(t),clearTimeout(this.renderDataLayerTimeout),this.renderDataLayerTimeout=setTimeout(()=>{this.renderDataLayer()},500)}renderErasedPixelsFromInteractionLayerInDataLayer(){var e,t;let r=this.interactionLayer.getAllErasedPixels();if(r.length>0){let i=this.dataLayer.getContext(),a=this.gridSquareLength*this.panZoom.scale,s=b(this.element,{x:0,y:0},this.dpr),n=M(s,this.panZoom);for(let s of r){let{rowIndex:r,columnIndex:o}=s,l=this.dataLayer.getRowKeyOrderMap().get(r),d=this.dataLayer.getColumnKeyOrderMap().get(o);if(void 0===d||void 0===l)continue;let h=null===(t=null===(e=this.dataLayer.getData().get(r))||void 0===e?void 0:e.get(o))||void 0===t?void 0:t.color;h&&i.clearRect(d*a+n.x,l*a+n.y,a,a)}}}renderDataLayer(){this.dataLayer.render()}renderInteractionLayer(){this.interactionLayer.render()}destroy(){ek(this.element,eM,"mouseup",this.onMouseUp),ek(this.element,eM,"mouseout",this.onMouseOut),ek(this.element,eM,"mousedown",this.onMouseDown),ek(this.element,eM,"mousemove",this.onMouseMove),ek(this.element,eM,"mousemove",this.handlePinchZoom),this.element.removeEventListener("wheel",this.handleWheel)}}let eW=(0,y.forwardRef)(function(e,t){let r=(0,y.useRef)(null),[i,a]=(0,y.useState)(null),[s,n]=(0,y.useState)(null),[o,l]=(0,y.useState)(null),[d,h]=(0,y.useState)(null),[c,g]=(0,y.useState)(null),[x,m]=(0,y.useState)(null),[L,f]=(0,y.useState)([]),[p,C]=(0,y.useState)([]),[P,S]=(0,y.useState)([]),[w,A]=(0,y.useState)([]),[E,T]=(0,y.useState)([]),[v,D]=(0,y.useState)([]),[b,R]=(0,y.useState)([]),[B,M]=(0,y.useState)([]);(0,y.useEffect)(()=>{x&&x.setIsGridFixed(e.isGridFixed)},[x,e.isGridFixed]),(0,y.useEffect)(()=>{x&&x.setGridStrokeColor(e.gridStrokeColor)},[x,e.gridStrokeColor]),(0,y.useEffect)(()=>{x&&x.setGridStrokeWidth(e.gridStrokeWidth)},[x,e.gridStrokeWidth]),(0,y.useEffect)(()=>{x&&x.setIsGridVisible(e.isGridVisible)},[x,e.isGridVisible]),(0,y.useEffect)(()=>{x&&x.setIsPanZoomable(e.isPanZoomable)},[x,e.isPanZoomable]),(0,y.useEffect)(()=>{x&&x.setIsInteractionApplicable(e.isInteractionApplicable)},[x,e.isInteractionApplicable]),(0,y.useEffect)(()=>{x&&x.setGridSquareLength(e.gridSquareLength)},[x,e.gridSquareLength]),(0,y.useEffect)(()=>{x&&x.setDefaultPixelColor(e.defaultPixelColor)},[x,e.defaultPixelColor]),(0,y.useEffect)(()=>{x&&x.setMinScale(e.minScale)},[x,e.minScale]),(0,y.useEffect)(()=>{x&&x.setMaxScale(e.maxScale)},[x,e.maxScale]),(0,y.useEffect)(()=>{if(x)return p.forEach(e=>{x.addEventListener(u.GRID_CHANGE,e)}),x.emitCurrentGridStatus(),()=>{p.forEach(e=>{null==x||x.removeEventListener(u.GRID_CHANGE,e)})}},[x,p]),(0,y.useEffect)(()=>{if(x)return L.forEach(e=>{x.addEventListener(u.DATA_CHANGE,e)}),x.emitCurrentData(),()=>{L.forEach(e=>{null==x||x.removeEventListener(u.DATA_CHANGE,e)})}},[x,L]),(0,y.useEffect)(()=>{if(x)return w.forEach(e=>{x.addEventListener(u.BRUSH_CHANGE,e)}),x.emitCurrentBrushTool(),()=>{w.forEach(e=>{null==x||x.removeEventListener(u.BRUSH_CHANGE,e)})}},[x,w]),(0,y.useEffect)(()=>{if(x)return P.forEach(e=>{x.addEventListener(u.STROKE_END,e)}),()=>{P.forEach(e=>{null==x||x.removeEventListener(u.STROKE_END,e)})}},[x,P]),(0,y.useEffect)(()=>{if(x)return E.forEach(e=>{x.addEventListener(u.HOVER_PIXEL_CHANGE,e)}),x.emitCurrentHoverPixelStatus(),()=>{E.forEach(e=>{null==x||x.removeEventListener(u.HOVER_PIXEL_CHANGE,e)})}},[x,E]),(0,y.useEffect)(()=>{if(x)return v.forEach(e=>{x.addEventListener(u.LAYER_CHANGE,e)}),x.emitCurrentLayerStatus(),()=>{v.forEach(e=>{null==x||x.removeEventListener(u.LAYER_CHANGE,e)})}},[x,v]),(0,y.useEffect)(()=>{if(x)return b.forEach(e=>{x.addEventListener(u.CANVAS_INFO_CHANGE,e)}),x.emitCurrentCanvasInfoStatus(),()=>{b.forEach(e=>{null==x||x.removeEventListener(u.CANVAS_INFO_CHANGE,e)})}},[x,b]),(0,y.useEffect)(()=>{if(x)return B.forEach(({type:e,listener:t})=>{let r=x.getCanvasElement();r.addEventListener(e,t)}),()=>{B.forEach(({type:e,listener:t})=>{let r=x.getCanvasElement();r.removeEventListener(e,t)})}},[x,B]),(0,y.useEffect)(()=>{let e=()=>{if(r.current&&x){let e=window.devicePixelRatio,t=r.current.getBoundingClientRect();x.setSize(t.width,t.height,e),x.scale(e,e),x.renderAll()}};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}},[x,r,e.height,e.width,c,i]),(0,y.useEffect)(()=>{x&&e.indicatorData&&x.setIndicatorPixels(e.indicatorData)},[x,e.indicatorData]),(0,y.useEffect)(()=>{x&&(e.brushColor&&x.setBrushColor(e.brushColor),e.brushTool&&x.setBrushTool(e.brushTool))},[x,e.brushColor,e.brushTool]),(0,y.useEffect)(()=>{x&&e.backgroundColor&&x.setBackgroundColor(e.backgroundColor)},[x,e.backgroundColor]),(0,y.useEffect)(()=>{if(!s||!d||!o||!c||!i||!r.current)return;let{width:t,height:a}=r.current.getBoundingClientRect(),n=e.initLayers&&ed(e.initLayers)?e.initLayers:void 0,l=window.devicePixelRatio,h=new eG({gridCanvas:s,interactionCanvas:d,dataCanvas:o,backgroundCanvas:c,foregroundCanvas:i,initLayers:n,gridSquareLength:e.gridSquareLength,width:t,height:a,dpr:l});return l&&h.scale(l,l),h.setIsGridFixed(e.isGridFixed),h.setIsInteractionApplicable(e.isInteractionApplicable),h.setIsDrawingEnabled(e.isDrawingEnabled),h.setIsPanZoomable(e.isPanZoomable),h.setIsGridVisible(e.isGridVisible),h.setGridStrokeColor(e.gridStrokeColor),h.setGridStrokeWidth(e.gridStrokeWidth),h.setGridSquareLength(e.gridSquareLength),h.setDefaultPixelColor(e.defaultPixelColor),h.setMinScale(e.minScale),h.setMaxScale(e.maxScale),m(h),()=>{h.destroy()}},[s,d,o,c]);let O=(0,y.useCallback)(e=>{e&&(e.style.touchAction="none",n(e))},[]),k=(0,y.useCallback)(e=>{e&&(e.style.touchAction="none",h(e))},[]),G=(0,y.useCallback)(e=>{e&&(e.style.touchAction="none",l(e))},[]),W=(0,y.useCallback)(e=>{e&&(e.style.touchAction="none",g(e))},[]),H=(0,y.useCallback)(e=>{e&&(e.style.touchAction="none",a(e))},[]),F=(0,y.useCallback)(e=>{f(t=>[...t,e])},[]),Z=(0,y.useCallback)(e=>{x.removeEventListener(u.DATA_CHANGE,e),f(t=>t.filter(t=>t!==e))},[x]),q=(0,y.useCallback)(e=>{C(t=>[...t,e])},[]),N=(0,y.useCallback)(e=>{x.removeEventListener(u.GRID_CHANGE,e),C(t=>t.filter(t=>t!==e))},[x]),K=(0,y.useCallback)(e=>{A(t=>[...t,e])},[]),_=(0,y.useCallback)(e=>{x.removeEventListener(u.BRUSH_CHANGE,e),A(t=>t.filter(t=>t!==e))},[x]),z=(0,y.useCallback)(e=>{S(t=>[...t,e])},[]),j=(0,y.useCallback)(e=>{x.removeEventListener(u.STROKE_END,e),S(t=>t.filter(t=>t!==e))},[x]),X=(0,y.useCallback)(e=>{T(t=>[...t,e])},[]),V=(0,y.useCallback)(e=>{x.removeEventListener(u.HOVER_PIXEL_CHANGE,e),T(t=>t.filter(t=>t!==e))},[x]),Y=(0,y.useCallback)(e=>{R(t=>[...t,e])},[]),U=(0,y.useCallback)(e=>{x.removeEventListener(u.CANVAS_INFO_CHANGE,e),R(t=>t.filter(t=>t!==e))},[x]),$=(0,y.useCallback)((e,t)=>{M(r=>[...r,{type:e,listener:t}])},[x]),J=(0,y.useCallback)((e,t)=>{if(!x)return;let r=x.getCanvasElement();r.removeEventListener(e,t),M(r=>r.filter(r=>r.type!==e&&r.listener!==t))},[x]),Q=(0,y.useCallback)(e=>{D(t=>[...t,e])},[]),ee=(0,y.useCallback)(e=>{x&&(x.removeEventListener(u.LAYER_CHANGE,e),D(t=>t.filter(t=>t!==e)))},[x]),et=(0,y.useCallback)(()=>null==x?void 0:x.clear(),[x]),er=(0,y.useCallback)(e=>{null==x||x.colorPixels(e)},[x]),ei=(0,y.useCallback)(e=>{null==x||x.erasePixels(e)},[x]),ea=(0,y.useCallback)(e=>{null==x||x.setIndicatorPixels(e)},[x]),es=(0,y.useCallback)(e=>{null==x||x.downloadImage(e)},[x]),en=(0,y.useCallback)(e=>{null==x||x.changeBrushColor(e)},[x]),eo=(0,y.useCallback)(e=>{null==x||x.setBrushPattern(e)},[x]),el=(0,y.useCallback)(e=>{null==x||x.setBrushTool(e)},[x]),eh=(0,y.useCallback)(()=>{null==x||x.undo()},[x]),eu=(0,y.useCallback)(()=>{null==x||x.redo()},[x]),ec=(0,y.useCallback)(e=>{null==x||x.setData(e)},[x]),eg=(0,y.useCallback)((e,t,r)=>{null==x||x.addLayer(e,t,r,!0)},[x]),ex=(0,y.useCallback)(e=>{null==x||x.removeLayer(e,!0)},[x]),ey=(0,y.useCallback)((e,t)=>{null==x||x.changeLayerPosition(e,t)},[x]),em=(0,y.useCallback)(e=>{null==x||x.showLayer(e)},[x]),eL=(0,y.useCallback)(e=>{null==x||x.hideLayer(e)},[x]),ef=(0,y.useCallback)(e=>{null==x||x.isolateLayer(e)},[x]),eI=(0,y.useCallback)(()=>{null==x||x.showAllLayers()},[x]),ep=(0,y.useCallback)(e=>{null==x||x.setCurrentLayer(e)},[x]),eC=(0,y.useCallback)(e=>{null==x||x.reorderLayersByIds(e)},[x]),eP=(0,y.useCallback)(({rowIndices:e,columnIndices:t,data:r,layerId:i,isLocalChange:a=!1})=>{null==x||x.addGridIndices({rowIndices:e,columnIndices:t,data:r,layerId:i,isLocalChange:a})},[x]),eS=(0,y.useCallback)(({rowIndices:e,columnIndices:t,layerId:r,isLocalChange:i=!1})=>{null==x||x.deleteGridIndices({rowIndices:e,columnIndices:t,layerId:r,isLocalChange:i})},[x]),ew=(0,y.useCallback)(()=>null==x?void 0:x.getLayers(),[x]),eA=(0,y.useCallback)(()=>null==x?void 0:x.getLayersAsArray(),[x]),eE=(0,y.useCallback)(e=>{null==x||x.setLayers(e)},[x]),eT=(0,y.useCallback)(e=>{let t=new MouseEvent("mousedown",{clientX:e.offsetX,clientY:e.offsetY});null==x||x.onMouseDown(t)},[x]),ev=(0,y.useCallback)(e=>{let t=new MouseEvent("mousemove",{clientX:e.offsetX,clientY:e.offsetY});null==x||x.onMouseMove(t)},[x]),eD=(0,y.useCallback)(e=>{let t=new MouseEvent("mouseup",{clientX:e.offsetX,clientY:e.offsetY});null==x||x.onMouseUp(t)},[x]),eb=(0,y.useCallback)(()=>i,[i]),eR=(0,y.useCallback)(()=>c,[c]),eB=(0,y.useCallback)((e,t)=>null==x?void 0:x.convertWorldPosToCanvasOffset({x:e,y:t}),[x]);return(0,y.useImperativeHandle)(t,()=>({clear:et,colorPixels:er,erasePixels:ei,downloadImage:es,setIndicatorPixels:ea,undo:eh,redo:eu,setData:ec,addGridIndices:eP,deleteGridIndices:eS,changeBrushColor:en,changeBrushTool:el,changeBrushPattern:eo,addLayer:eg,removeLayer:ex,changeLayerPosition:ey,showLayer:em,hideLayer:eL,isolateLayer:ef,showAllLayers:eI,setCurrentLayer:ep,reorderLayersByIds:eC,addDataChangeListener:F,removeDataChangeListener:Z,addGridChangeListener:q,removeGridChangeListener:N,addBrushChangeListener:K,removeBrushChangeListener:_,addStrokeEndListener:z,removeStrokeEndListener:j,addHoverPixelChangeListener:X,removeHoverPixelChangeListener:V,addLayerChangeEventListener:Q,removeLayerChangeEventListener:ee,addCanvasInfoChangeEventListener:Y,removeCanvasInfoChangeEventListener:U,addCanvasElementEventListener:$,removeCanvasElementEventListener:J,getLayers:ew,getLayersAsArray:eA,setLayers:eE,onMouseDown:eT,onMouseMove:ev,onMouseUp:eD,getForegroundCanvas:eb,getBackgroundCanvas:eR,convertWorldPosToCanvasOffset:eB}),[et,er,ei,es,ea,eh,eu,ec,eP,eS,en,el,eo,eg,ex,ey,em,eL,ef,eI,eC,F,Z,q,N,K,_,z,j,X,V,Q,ee,Y,U,$,J,ew,eA,eE,eT,ev,eD,eb,eR,eB]),y.createElement("div",{style:{width:e.width,height:e.height,position:"relative",outline:"none"},ref:r,tabIndex:1,onMouseDown:()=>{var e;null===(e=r.current)||void 0===e||e.focus()},onKeyDown:e=>{null==x||x.onKeyDown(e)},onKeyUp:e=>{null==x||x.onKeyUp(e)}},y.createElement("canvas",{id:"dotting-background-canvas",ref:W,style:Object.assign({position:"absolute",border:"1px solid #555555",pointerEvents:"none",backgroundColor:e.backgroundColor?e.backgroundColor:I},e.style)}),y.createElement("canvas",{id:"dotting-data-canvas",ref:G,style:Object.assign({position:"absolute",pointerEvents:"none",border:"1px solid #555555"},e.style)}),y.createElement("canvas",{id:"dotting-interaction-canvas",ref:k,style:Object.assign({position:"absolute",border:"1px solid #555555"},e.style)}),y.createElement("canvas",{id:"dotting-grid-canvas",ref:O,style:Object.assign({position:"absolute",pointerEvents:"none",border:"1px solid #555555"},e.style)}),y.createElement("canvas",{ref:H,id:"dotting-foreground-canvas",style:Object.assign({position:"absolute",pointerEvents:"none",border:"1px solid #555555"},e.style)}))})}}]);